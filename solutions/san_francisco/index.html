<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>San Francisco Mycelial Solutions â€” Proof-of-Concept Governance Scaffold</title>
  <meta name="description" content="Decentralized mycelial solutions index for city governance. Modular smart-contract hooks, open-data ingestion, transparency dashboards, and offline-first UX for rapid pilots." />
  <meta name="theme-color" content="#0b132b" />
  <meta name="author" content="Foster + Navi â€” Planetary Restoration Archive" />
  
  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       INDEX.HTML: San Francisco Mycelial Solutions (PoC) â€” ENHANCED EDITION
       VERSION: 2.0.0 (Expanded with Gamification, Parallax, Multi-theme)
       
       PURPOSE: One-file, online-first dashboard with offline fallback to help
       governments pilot decentralized, transparent, myceliumâ€‘inspired programs.
       
       DESIGN PRINCIPLES
       - Decentralization: federation of modules; no single control chokepoint.
       - Transparency: verifiable data trails; cryptographic signatures.
       - Consent & Zero Harm: publish minimal necessary data, protect identities.
       - Interoperability: JSON schema, IPFS-ready manifests, EVM/Solana hooks.
       - Offline-first: Service Worker + IndexedDB for resilient field ops.
       - Gamification: XP, achievements, daily quests to incentivize civic action.
       - Narrative: Blend scientific accuracy with mythological resonance.

       ZERO-HARM / ANTI-INVERSION COMMITMENT
       This tool is designed for civic empowerment, ecological restoration, and
       transparent governance. It MUST NOT be weaponized, used for surveillance
       without consent, or deployed to extract value from communities.
       
       - All analytics are opt-in and transparent.
       - No hidden tracking pixels or third-party scripts.
       - Data minimization: collect only what's necessary.
       - Right to deletion: users can purge their data at any time.
       - Non-commercial: this scaffold prioritizes commons over profit.
       
       LICENSE: CC BY-SA 4.0 â€” Share, adapt, but keep attribution and copyleft.
       Attribution: Foster + Navi, Planetary Restoration Archive
       
       SAFETY FEATURES
       - Rate limiting on all API calls (10 req/min client-side)
       - Input sanitization for user-generated content
       - CSP-friendly (no eval, no inline event handlers)
       - Abuse resistance: CAPTCHA-ready hooks for public deployments
       - Privacy guardrails: metadata stripping, consent prompts

       ATTRIBUTIONS & LICENSES (Human-Readable Summary)
       - MapLibre GL JS (BSD-3-Clause): map rendering, https://maplibre.org
       - Papaparse (MIT): CSV parsing, https://www.papaparse.com
       - D3.js (ISC): data visualization, https://d3js.org
       - IndexedDB API (W3C Standard): local storage
       - Web Crypto API (W3C Standard): hashing, signatures
       - Design patterns adapted from municipal dashboards (public domain concepts)
       - Constellation data: simplified from HYG Database (public domain)
       
       Full license texts available in linked repositories.
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

  <!-- â”€â”€ Configuration (data-* attributes for easy customization) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <meta id="cfg"
        data-city="San Francisco"
        data-chain-evm-rpc="https://ethereum.publicnode.com"
        data-chain-sol-rpc="https://api.mainnet-beta.solana.com"
        data-ipfs-gateway="https://ipfs.io/ipfs/"
        data-datasf-root="https://data.sfgov.org/resource/"
        data-expected-hash="EXPECTED_HASH_TO_SET_POST_DEPLOY"
        data-tlkio-room="PRA-Mycelial-SF"
        data-site-owner="Foster + Navi"
        data-site-url="https://planetaryrestorationarchive.com"
        data-analytics-email="admin@planetaryrestorationarchive.com"
        data-theme="auto"
        data-xp-multiplier="1.0" />

  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: BASE VARIABLES & THEME ENGINE
       
       WHAT: CSS custom properties for theming, including auto dark mode
       HOW TO USE: Themes switch via data-theme attribute on <html>
       EXPECTED OUTCOME: Seamless theme transitions, accessible contrast
       
       EXPANSION PROMPT: "Add more theme presets: medieval (earthy tones, 
       serif fonts), cyberpunk (neon purples, glitch effects), solarpunk 
       (greens, organic shapes), lunar (grays, minimal), coral (oceanic blues 
       and corals). Include theme-specific fonts and accent colors."
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    :root, [data-theme="auto"] {
      /* Base palette: deep space blues */
      --bg:#0b132b; --ink:#e0e6f8; --muted:#9fb3c8; --em:#00d1ff; 
      --ok:#00c896; --warn:#ffc857; --bad:#ff4d6d;
      --panel:#15223b; --card:#101a30; --accent:#1f2d4d; --accent-bright:#3d5a8c;
      
      /* Gamification colors */
      --xp-bar:#4ecdc4; --xp-glow:#7afff7; --achievement:#ffd700; 
      --quest-active:#ff6b9d; --quest-complete:#50fa7b;
      
      /* Fonts */
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, sans-serif;
      --serif: "Iowan Old Style", "Palatino Linotype", Palatino, Georgia, serif;
      
      /* Spacing & sizing */
      --radius-sm:8px; --radius-md:12px; --radius-lg:16px; --radius-xl:24px;
      --shadow-sm:0 2px 8px rgba(0,0,0,.15); --shadow-md:0 4px 16px rgba(0,0,0,.25); 
      --shadow-lg:0 10px 30px rgba(0,0,0,.35); --shadow-glow:0 0 20px rgba(0,209,255,.3);
      
      /* Constellation parallax layers */
      --star-fg:#a5c9ff; --star-mid:#6e8fb5; --star-bg:#4a5f7f;
      --nebula:#1a2845;
    }

    @media (prefers-color-scheme: dark) {
      :root, [data-theme="auto"] {
        /* Already dark, no changes needed */
      }
    }

    @media (prefers-color-scheme: light) {
      :root[data-theme="auto"] {
        --bg:#f5f7fa; --ink:#1a1f2e; --muted:#64748b; --em:#0066cc;
        --panel:#ffffff; --card:#f8fafc; --accent:#e2e8f0; --accent-bright:#cbd5e1;
        --star-fg:#b0c4de; --star-mid:#8fa3bd; --star-bg:#6b7fa0;
        --nebula:#d4dce6;
      }
    }

    /* Space theme (default) */
    [data-theme="space"] {
      --bg:#0a0e1a; --ink:#e8f0ff; --muted:#8fa4c8; --em:#00d4ff;
      --panel:#0f1623; --card:#0c111f; --accent:#1a2438;
      --xp-bar:#00ffcc; --achievement:#ffea00;
    }

    /* Medieval theme */
    [data-theme="medieval"] {
      --bg:#2b2416; --ink:#f4e8d8; --muted:#a89682; --em:#d4af37;
      --panel:#3a2f20; --card:#312618; --accent:#4a3828; --accent-bright:#6b5540;
      --xp-bar:#8b7355; --achievement:#ffd700; --quest-active:#b8860b;
      --sans: var(--serif);
    }

    /* Anime theme */
    [data-theme="anime"] {
      --bg:#ffe6f0; --ink:#2d1b2e; --muted:#8b5a7d; --em:#ff1493;
      --panel:#fff0f7; --card:#ffe6f5; --accent:#ffc0e0; --accent-bright:#ff69b4;
      --xp-bar:#ff69b4; --achievement:#ffeb3b; --quest-active:#00bcd4;
    }

    /* Cyberpunk theme */
    [data-theme="cyberpunk"] {
      --bg:#0d0221; --ink:#f72585; --muted:#b5179e; --em:#7209b7;
      --panel:#170431; --card:#0f0225; --accent:#3c096c; --accent-bright:#5a189a;
      --xp-bar:#00ffff; --achievement:#ff00ff; --quest-active:#ff006e;
    }

    /* Solarpunk theme */
    [data-theme="solarpunk"] {
      --bg:#1a2f1a; --ink:#e8f5e9; --muted:#81c784; --em:#66bb6a;
      --panel:#2e4a2e; --card:#243824; --accent:#388e3c; --accent-bright:#4caf50;
      --xp-bar:#8bc34a; --achievement:#ffeb3b; --quest-active:#ff9800;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: RESET & BASE STYLES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 700px at 80% -10%, var(--accent-bright) 0%, var(--bg) 45%, var(--card) 100%);
      color: var(--ink);
      font-family: var(--sans);
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      position: relative;
    }
    
    a { color: var(--em); text-decoration: none; transition: all .2s ease; }
    a:hover { text-decoration: underline; filter: brightness(1.2); }
    a:focus-visible { outline: 2px solid var(--em); outline-offset: 2px; }

    button {
      font-family: inherit;
      cursor: pointer;
      border: none;
      transition: all .2s ease;
    }
    button:hover { transform: translateY(-1px); filter: brightness(1.1); }
    button:active { transform: translateY(0); }
    button:focus-visible { outline: 2px solid var(--em); outline-offset: 2px; }

    input, textarea, select {
      font-family: inherit;
      padding: 8px 12px;
      border: 1px solid var(--accent);
      border-radius: var(--radius-sm);
      background: var(--card);
      color: var(--ink);
      font-size: .95rem;
    }
    input:focus, textarea:focus, select:focus {
      outline: 2px solid var(--em);
      outline-offset: 1px;
    }

    code, pre {
      font-family: var(--mono);
      background: var(--card);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: .9em;
    }
    pre {
      padding: 12px;
      overflow-x: auto;
      border: 1px solid var(--accent);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: LAYOUT PRIMITIVES
       
       WHAT: Responsive grid, flexbox utilities, container queries
       EXPANSION PROMPT: "Add CSS container queries for micro-layouts within 
       cards, masonry grid for heterogeneous content, sticky scroll-spy nav"
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .wrap { max-width: 1400px; margin: 0 auto; padding: 16px; position: relative; z-index: 10; }
    .grid { display: grid; gap: 16px; }
    .grid.cols-2 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .grid.cols-3 { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .grid.cols-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    @media (min-width: 900px) {
      .grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
      .grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
      .grid.cols-4 { grid-template-columns: repeat(4, 1fr); }
    }

    .flex { display: flex; gap: 12px; align-items: center; }
    .flex-col { flex-direction: column; align-items: stretch; }
    .flex-wrap { flex-wrap: wrap; }
    .flex-between { justify-content: space-between; }
    .flex-center { justify-content: center; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: CARD & PANEL COMPONENTS
       
       WHAT: Glassmorphic cards with hover effects, collapsible sections
       HOW TO USE: Add .card class, use <details> for collapsibles
       EXPANSION PROMPT: "Add swipe gestures for mobile, drag-to-reorder cards, 
       pinned/favorite cards that stay at top, card minimization"
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .card {
      background: linear-gradient(160deg, var(--panel), var(--card));
      border: 1px solid var(--accent);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(10px);
      transition: all .3s ease;
      position: relative;
    }
    .card:hover {
      box-shadow: var(--shadow-lg);
      border-color: var(--accent-bright);
      transform: translateY(-2px);
    }
    .card h3 {
      margin: 0 0 12px 0;
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: .01em;
      color: var(--em);
    }
    .card h4 {
      margin: 16px 0 8px 0;
      font-size: 1rem;
      font-weight: 500;
      color: var(--ink);
    }
    .card p {
      margin: 8px 0;
    }
    .card details {
      margin-top: 12px;
    }
    .card details summary {
      cursor: pointer;
      font-weight: 500;
      padding: 8px 0;
      color: var(--em);
      user-select: none;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card details summary::-webkit-details-marker { display: none; }
    .card details summary::before {
      content: 'â–¸';
      font-size: 1.2em;
      transition: transform .2s ease;
      display: inline-block;
    }
    .card details[open] summary::before {
      transform: rotate(90deg);
    }
    .card details[open] {
      border-top: 1px solid var(--accent);
      padding-top: 12px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: GAMIFICATION HUD
       
       WHAT: Fixed overlay showing XP, level, streak, active quests
       HOW TO USE: Auto-populated from IndexedDB "gamification" store
       EXPECTED OUTCOME: Visible XP bar fills on actions, confetti on level-up
       
       EXPANSION PROMPT: "Add animated skill trees, achievement showcase modal 
       with rarity tiers (common/rare/epic/legendary), daily login rewards, 
       leaderboard with privacy-preserving pseudonyms, seasonal events"
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .hud {
      position: fixed;
      top: 80px;
      right: 16px;
      z-index: 100;
      background: linear-gradient(135deg, var(--panel), var(--card));
      border: 1px solid var(--accent-bright);
      border-radius: var(--radius-lg);
      padding: 16px;
      min-width: 280px;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(12px);
      transition: all .3s ease;
      opacity: 0.95;
    }
    .hud:hover {
      opacity: 1;
      box-shadow: var(--shadow-glow);
    }
    
    @media (max-width: 768px) {
      .hud {
        top: auto;
        bottom: 80px;
        right: 8px;
        min-width: 240px;
        padding: 12px;
        font-size: .9rem;
      }
    }

    .hud-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .hud-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--em);
    }
    .hud-level {
      background: var(--accent-bright);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .85rem;
      font-weight: 700;
      color: var(--ink);
    }

    .xp-container {
      margin-bottom: 16px;
    }
    .xp-label {
      display: flex;
      justify-content: space-between;
      font-size: .85rem;
      margin-bottom: 4px;
      color: var(--muted);
    }
    .xp-bar-bg {
      height: 12px;
      background: var(--accent);
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }
    .xp-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--xp-bar), var(--xp-glow));
      border-radius: 999px;
      transition: width .5s ease;
      box-shadow: 0 0 10px var(--xp-glow);
      position: relative;
    }
    .xp-bar-fill::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0%, 100% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat-card {
      background: var(--card);
      padding: 8px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--accent);
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--em);
      font-family: var(--mono);
    }
    .stat-label {
      font-size: .75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    .quest-list {
      max-height: 200px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .quest-list::-webkit-scrollbar {
      width: 6px;
    }
    .quest-list::-webkit-scrollbar-track {
      background: var(--card);
      border-radius: 999px;
    }
    .quest-list::-webkit-scrollbar-thumb {
      background: var(--accent-bright);
      border-radius: 999px;
    }

    .quest-item {
      background: var(--card);
      padding: 10px;
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--quest-active);
      margin-bottom: 8px;
      font-size: .85rem;
      transition: all .2s ease;
    }
    .quest-item:hover {
      transform: translateX(4px);
      border-left-color: var(--quest-complete);
    }
    .quest-item.complete {
      border-left-color: var(--quest-complete);
      opacity: .7;
    }
    .quest-item.complete .quest-title {
      text-decoration: line-through;
    }
    .quest-title {
      font-weight: 500;
      margin-bottom: 4px;
      color: var(--ink);
    }
    .quest-progress {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .75rem;
      color: var(--muted);
    }
    .quest-reward {
      color: var(--achievement);
      font-weight: 600;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: HEADER & NAVIGATION
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    header {
      position: sticky;
      top: 0;
      background: rgba(10, 16, 33, .8);
      backdrop-filter: blur(12px);
      z-index: 50;
      border-bottom: 1px solid var(--accent);
      box-shadow: var(--shadow-sm);
    }
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
    }
    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .brand h1 {
      margin: 0;
      font-size: 1.15rem;
      letter-spacing: .02em;
      font-weight: 600;
    }
    .brand svg {
      flex-shrink: 0;
    }
    .tag {
      font-size: .75rem;
      color: var(--muted);
      margin-top: 2px;
    }
    .nav-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    @media (max-width: 768px) {
      .brand h1 { font-size: 1rem; }
      .tag { font-size: .7rem; }
      .nav-actions { gap: 4px; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: BUTTONS & INTERACTIVE ELEMENTS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 8px 14px;
      border-radius: 999px;
      background: var(--accent);
      border: 1px solid var(--accent-bright);
      color: var(--ink);
      font-size: .85rem;
      font-weight: 500;
      white-space: nowrap;
      transition: all .2s ease;
    }
    .pill:hover {
      background: var(--accent-bright);
      box-shadow: var(--shadow-sm);
    }
    .pill.primary {
      background: var(--em);
      border-color: var(--em);
      color: var(--bg);
      font-weight: 600;
    }
    .pill.primary:hover {
      filter: brightness(1.15);
    }
    .pill.success {
      background: var(--ok);
      border-color: var(--ok);
      color: var(--bg);
    }
    .pill.warning {
      background: var(--warn);
      border-color: var(--warn);
      color: var(--bg);
    }
    .pill.danger {
      background: var(--bad);
      border-color: var(--bad);
      color: var(--ink);
    }

    .icon-btn {
      background: var(--card);
      border: 1px solid var(--accent);
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      color: var(--ink);
      font-size: .9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: UTILITIES & HELPERS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .kpi {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .kpi .val {
      font-size: 1.8rem;
      font-family: var(--mono);
      font-weight: 700;
      color: var(--em);
    }

    .muted { color: var(--muted); }
    .mono { font-family: var(--mono); }
    .small { font-size: .85rem; }
    .em { color: var(--em); }
    .section-title {
      margin: 32px 0 16px 0;
      font-weight: 700;
      letter-spacing: .02em;
      font-size: 1.5rem;
      color: var(--em);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .section-title::before {
      content: '';
      width: 4px;
      height: 24px;
      background: var(--em);
      border-radius: 2px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: PARALLAX CONSTELLATION CANVAS
       
       WHAT: Multi-layer starfield with mouse parallax, clickable constellations
       HOW TO USE: Auto-initializes on load, responds to mouse/touch movement
       EXPECTED OUTCOME: Immersive depth, stars move at different speeds
       
       EXPANSION PROMPT: "Add named constellations (Mycelium, Phoenix, Steward) 
       that trigger lore popups when clicked, shooting stars for achievements, 
       nebula clouds with animated gradients, seasonal constellation rotation"
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .constellation-canvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      opacity: 0.6;
      transition: opacity .5s ease;
    }
    body[data-theme="anime"] .constellation-canvas,
    body[data-theme="medieval"] .constellation-canvas {
      opacity: 0.3;
    }
    #starfield {
      width: 100%;
      height: 100%;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: FLOATING OVERLAYS (XMR, Chat, Theme Switcher)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .xmr {
      position: fixed;
      right: 12px;
      bottom: 12px;
      z-index: 80;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }
    .xmr button {
      background: var(--card);
      color: var(--ink);
      border: 1px solid var(--accent);
      padding: 10px 14px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: .9rem;
      box-shadow: var(--shadow-sm);
    }
    .xmr .panel {
      display: none;
      background: var(--panel);
      border: 1px solid var(--accent-bright);
      padding: 16px;
      border-radius: var(--radius-md);
      width: min(92vw, 480px);
      box-shadow: var(--shadow-lg);
    }
    .xmr .addr {
      word-break: break-all;
      font-family: var(--mono);
      font-size: .8rem;
      background: var(--card);
      padding: 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--accent);
      margin: 8px 0;
    }

    .chat-launch {
      position: fixed;
      left: 12px;
      bottom: 12px;
      z-index: 80;
    }
    .chat-launch button {
      background: var(--card);
      color: var(--ink);
      border: 1px solid var(--accent);
      padding: 10px 14px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: .9rem;
      box-shadow: var(--shadow-sm);
    }

    .theme-switcher {
      position: relative;
    }
    .theme-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--panel);
      border: 1px solid var(--accent-bright);
      border-radius: var(--radius-md);
      padding: 8px;
      min-width: 160px;
      box-shadow: var(--shadow-lg);
      z-index: 100;
    }
    .theme-option {
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: .85rem;
      transition: all .2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .theme-option:hover {
      background: var(--accent);
    }
    .theme-option.active {
      background: var(--accent-bright);
      font-weight: 600;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: INTEGRITY BANNER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .integrity {
      position: fixed;
      top: 8px;
      right: 12px;
      background: var(--panel);
      border: 1px solid var(--accent-bright);
      padding: 6px 12px;
      border-radius: var(--radius-md);
      font-family: var(--mono);
      font-size: .7rem;
      z-index: 60;
      box-shadow: var(--shadow-sm);
      opacity: 0.8;
      transition: opacity .3s ease;
    }
    .integrity:hover {
      opacity: 1;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: MODALS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 200;
      background: rgba(0, 0, 0, .7);
      backdrop-filter: blur(4px);
      animation: fadeIn .3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content {
      max-width: 800px;
      margin: 8vh auto;
      background: var(--panel);
      border: 1px solid var(--accent-bright);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-lg);
      max-height: 84vh;
      overflow-y: auto;
      animation: slideUp .3s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--em);
    }
    .modal-close {
      background: var(--card);
      border: 1px solid var(--accent);
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      font-size: 1.2rem;
      line-height: 1;
      cursor: pointer;
    }
    .modal-body label {
      display: block;
      margin-bottom: 16px;
    }
    .modal-body label span {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: .9rem;
    }
    .modal-body input,
    .modal-body textarea,
    .modal-body select {
      width: 100%;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: FOOTER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    footer {
      margin-top: 64px;
      padding: 24px 0;
      border-top: 1px solid var(--accent);
      opacity: .8;
      font-size: .85rem;
    }
    footer p {
      margin: 8px 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: ANIMATIONS & TRANSITIONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    @keyframes levelUp {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .level-up-anim {
      animation: levelUp .6s ease;
    }

    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-400px) rotate(720deg); opacity: 0; }
    }
    .confetti-particle {
      position: fixed;
      width: 10px;
      height: 10px;
      z-index: 300;
      pointer-events: none;
      animation: confetti 2s ease-out forwards;
    }

    /* Print styles */
    @media print {
      .hud, .xmr, .chat-launch, .theme-switcher, .integrity, .constellation-canvas {
        display: none !important;
      }
      body {
        background: white;
        color: black;
      }
      .card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ccc;
      }
    }

    /* Accessibility: Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      .constellation-canvas {
        display: none;
      }
    }

    /* Dark mode forced override (for testing) */
    [data-force-dark="true"] {
      --bg:#0b132b; --ink:#e0e6f8;
    }

    /* noscript fallback */
    noscript {
      display: block;
      padding: 20px;
      background: var(--warn);
      color: var(--bg);
      text-align: center;
      font-weight: 600;
    }
  </style>

  <!-- MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  
  <!-- D3.js for advanced visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
</head>
<body data-theme="auto">
  <noscript>
    âš ï¸ This application requires JavaScript to function. Please enable JavaScript in your browser settings.
  </noscript>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Constellation Canvas
       
       WHAT: Multi-layer parallax starfield with interactive constellations
       HOW TO USE: Mouse movement creates parallax effect, touch for mobile
       EXPECTED OUTCOME: Immersive spatial depth, responsive to interaction
       
       FUTURE: Add clickable constellation markers that open lore modals
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="constellation-canvas"><canvas id="starfield" aria-hidden="true"></canvas></div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Header Navigation
       
       WHAT: Sticky header with brand, theme switcher, and quick actions
       HOW TO USE: Always visible at top, auto-hides on scroll down (optional)
       EXPECTED OUTCOME: Quick access to settings, theme changes, integrity info
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <header>
    <div class="wrap">
      <div class="header-content">
        <div class="brand">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" opacity=".6"/>
            <path d="M6 14c2.5-1.5 4-1 6-3 2-.5 3.5-2.5 6-3" stroke="currentColor" stroke-width="1.5" opacity=".8"/>
            <circle cx="12" cy="12" r="3" fill="currentColor" opacity=".4"/>
          </svg>
          <div>
            <h1>San Francisco Mycelial Solutions</h1>
            <div class="tag">Decentralized â€¢ Transparent â€¢ Gamified â€¢ Offline-First</div>
          </div>
        </div>
        <div class="nav-actions">
          <div class="theme-switcher">
            <button class="icon-btn" id="theme-toggle" title="Change theme" aria-label="Theme selector">
              ğŸ¨ Theme
            </button>
            <div class="theme-menu" id="theme-menu">
              <div class="theme-option" data-theme="auto">ğŸŒ“ Auto</div>
              <div class="theme-option" data-theme="space">ğŸŒŒ Space</div>
              <div class="theme-option" data-theme="medieval">ğŸ° Medieval</div>
              <div class="theme-option" data-theme="anime">ğŸŒ¸ Anime</div>
              <div class="theme-option" data-theme="cyberpunk">âš¡ Cyberpunk</div>
              <div class="theme-option" data-theme="solarpunk">ğŸŒ¿ Solarpunk</div>
            </div>
          </div>
          <button class="icon-btn" id="help-btn" title="Help & tutorial">â“</button>
        </div>
      </div>
    </div>
  </header>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Gamification HUD
       
       WHAT: Real-time XP, level, streak, active daily quests
       HOW TO USE: Auto-updates on actions (sync trees, post intent, etc.)
       EXPECTED OUTCOME: Visible progress, confetti animation on level-up
       
       DATA SOURCE: IndexedDB store "gamification" with schema:
       {
         xp: number,
         level: number,
         xpToNext: number,
         streak: number,
         actions: number,
         quests: [{id, title, progress, target, reward, complete}]
       }
       
       EXPANSION PROMPT: "Add achievement showcase, skill tree visualization,
       seasonal events, leaderboard with privacy mode, XP multipliers for 
       consecutive actions, rare drop notifications"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <aside class="hud" id="gamification-hud" aria-label="Player progress">
    <div class="hud-header">
      <div class="hud-title">ğŸŒ± Progress</div>
      <div class="hud-level" id="hud-level">Lvl 1</div>
    </div>
    
    <div class="xp-container">
      <div class="xp-label">
        <span id="xp-current">0</span>
        <span id="xp-next">/ 100 XP</span>
      </div>
      <div class="xp-bar-bg">
        <div class="xp-bar-fill" id="xp-bar" style="width: 0%"></div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="stat-streak">0</div>
        <div class="stat-label">Day Streak</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-actions">0</div>
        <div class="stat-label">Actions</div>
      </div>
    </div>

    <div>
      <div class="hud-title" style="font-size:.9rem;margin-bottom:8px">ğŸ“‹ Daily Quests</div>
      <div class="quest-list" id="quest-list">
        <div class="quest-item">
          <div class="quest-title">Sync street trees data</div>
          <div class="quest-progress">
            <span>0 / 1</span>
            <span class="quest-reward">+25 XP</span>
          </div>
        </div>
        <div class="quest-item">
          <div class="quest-title">Post 3 civic intents</div>
          <div class="quest-progress">
            <span>0 / 3</span>
            <span class="quest-reward">+50 XP</span>
          </div>
        </div>
        <div class="quest-item">
          <div class="quest-title">Complete a care credit</div>
          <div class="quest-progress">
            <span>0 / 1</span>
            <span class="quest-reward">+30 XP</span>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <main class="wrap">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Introduction Card
       
       WHAT: Mission statement, quick overview, zero-harm notice
       HOW TO USE: Always visible at top of main content
       EXPECTED OUTCOME: Clear value prop, ethical commitment visible
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="card" id="intro">
      <h3>ğŸ„ Purpose & Mission</h3>
      <p>
        This single-file pilot demonstrates how a city can orchestrate <span class="em">myceliumâ€‘inspired</span> civic programs using modular, decentralized components. 
        Each module operates as a standalone microservice or federates into larger ecosystems. Smartâ€‘contract hooks, integrity checks, and openâ€‘data pipes enable rapid municipal trials.
      </p>
      <p class="small muted">
        <strong>Zero-Harm Commitment:</strong> This tool is designed for civic empowerment, not surveillance or extraction. 
        All data collection is transparent, opt-in, and deletable. We prioritize commons over profit, consent over coercion, and restoration over extraction.
      </p>
      <div class="grid cols-4">
        <div class="pill">ğŸ”“ Zeroâ€‘Harm</div>
        <div class="pill">ğŸ” Cryptographic Transparency</div>
        <div class="pill">ğŸ§© Modular & Forkable</div>
        <div class="pill">ğŸ“´ Offline-First</div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Live KPI Dashboard
       
       WHAT: Real-time metrics from cached data + live APIs
       HOW TO USE: Auto-refreshes on page load, manual refresh button
       EXPECTED OUTCOME: Quick health check of connected systems
       
       DATA SOURCES:
       - Trees: DataSF street trees dataset (cached in IndexedDB)
       - 311: DataSF 311 cases, filtered to last 24h
       - Intents: Local ledger count from IndexedDB
       - Health: Composite score (0-100) based on data freshness
       
       EXPANSION PROMPT: "Add sparkline charts showing 7-day trends, color-coded
       health indicators (green/yellow/red), drill-down modals for each KPI,
       export to CSV, comparison to city averages"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="grid cols-4" id="kpis">
      <div class="card kpi">
        <div>
          <div class="muted small">ğŸŒ³ Trees Mapped</div>
          <div class="val" id="kpi-trees">â€“</div>
          <div class="small muted">Cached locally</div>
        </div>
      </div>
      <div class="card kpi">
        <div>
          <div class="muted small">ğŸ“ 311 Cases (24h)</div>
          <div class="val" id="kpi-311">â€“</div>
          <div class="small muted">Live from DataSF</div>
        </div>
      </div>
      <div class="card kpi">
        <div>
          <div class="muted small">ğŸ“ Intents Posted</div>
          <div class="val" id="kpi-intents">â€“</div>
          <div class="small muted">Local ledger</div>
        </div>
      </div>
      <div class="card kpi">
        <div>
          <div class="muted small">ğŸ’š System Health</div>
          <div class="val" id="kpi-health">â€“</div>
          <div class="small muted">Composite score</div>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION DIVIDER: Mycelial Solution Modules
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <h2 class="section-title">ğŸ„ Mycelial Solution Modules</h2>
    <p class="small muted" style="margin-bottom:24px">
      Each module is a self-contained governance primitive that can operate independently or compose with others. 
      Modules share a common schema (<code class="mono">mycelial.action.v1</code>) but implement domain-specific logic.
      Gamification hooks reward civic actions with XP and Care Credits.
    </p>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Module A - Myco-Storm Drains
       
       WHAT: Decentralized bioswale/drain maintenance with bounties
       HOW IT WORKS:
       1. Residents identify clogged drains or bioswales needing care
       2. Post intent with photo evidence (metadata-stripped for privacy)
       3. Community verifiers validate (quorum-based, 2-of-3 minimum)
       4. Smart contract releases escrowed bounty on verification
       5. Action logged on-chain (or IPFS + local ledger for demo)
       
       GAMIFICATION:
       - Post intent: +15 XP
       - Verification accepted: +25 XP, +1 Care Credit
       - Complete 10 actions: "Drain Guardian" achievement (+100 XP)
       
       DATA FEEDS:
       - Rainfall data (NOAA API proxy)
       - Historical drain maintenance logs
       - Flood risk zones (geospatial overlay)
       
       SCHEMA: mycelial.action.v1 with module="drains"
       
       EXPANSION PROMPT: "Add ML-based drain risk prediction using rainfall +
       historic blockage data, AR overlay for on-site verification, automated
       bounty pricing based on urgency, seasonal challenge events (monsoon prep),
       leaderboard for top drain guardians"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="card" id="module-drains">
      <h3>ğŸŒŠ Mycoâ€‘Storm Drains (Biofiltration + Bounties)</h3>
      <div class="flex" style="margin-bottom:12px">
        <span class="pill small">Schema: <code class="mono">mycelial.action.v1</code></span>
        <span class="pill small">Hook: <code class="mono">evm:postIntent()</code></span>
        <span class="pill small success">+15 XP per action</span>
      </div>
      
      <details>
        <summary>ğŸ“– Concept & Workflow</summary>
        <div style="padding:12px 0">
          <p>
            Use fungal mats and native plants to biofilter storm runoff while incentivizing community maintenance. 
            This module transforms drain care from reactive municipal cleanup into proactive, rewarded civic action.
          </p>
          
          <h4>How It Works:</h4>
          <ol style="margin-left:20px">
            <li><strong>Identify:</strong> Spot a clogged drain or bioswale in your neighborhood</li>
            <li><strong>Document:</strong> Take photos (auto-stripped of GPS EXIF data for privacy)</li>
            <li><strong>Post Intent:</strong> Submit via smart contract with location + evidence hash</li>
            <li><strong>Verification:</strong> 2 community verifiers confirm work quality</li>
            <li><strong>Reward:</strong> Escrowed bounty released automatically (e.g., 5 USDC + 1 Care Credit)</li>
          </ol>

          <h4>Data Integration:</h4>
          <ul style="margin-left:20px">
            <li>Real-time rainfall alerts trigger proactive maintenance quests (+2x XP)</li>
            <li>Historical blockage data predicts high-risk zones (ML-powered)</li>
            <li>Geospatial heatmap shows areas needing attention</li>
          </ul>

          <h4>Privacy Guardrails:</h4>
          <ul style="margin-left:20px">
            <li>Photos stripped of metadata before IPFS upload</li>
            <li>Location data coarsened to ~100m grid for public display</li>
            <li>Pseudonymous DIDs for reputation tracking (opt-in)</li>
          </ul>

          <h4>Achievements:</h4>
          <ul style="margin-left:20px">
            <li>ğŸ¥‰ <strong>First Drop:</strong> Complete first drain action (+50 XP)</li>
            <li>ğŸ¥ˆ <strong>Watershed Guardian:</strong> 10 drains maintained (+150 XP)</li>
            <li>ğŸ¥‡ <strong>Monsoon Hero:</strong> 5 actions during storm events (+300 XP, rare badge)</li>
          </ul>
        </div>
      </details>

      <div class="grid cols-3" style="margin-top:16px">
        <button class="pill primary" data-action="post-intent" data-module="drains" title="Earn +15 XP">
          ğŸ“ Post Intent
        </button>
        <button class="pill" data-action="view-map" data-module="drains">
          ğŸ—ºï¸ Hotspot Map
        </button>
        <button class="pill" data-action="export-schema" data-module="drains">
          ğŸ’¾ Export Schema
        </button>
      </div>

      <div style="margin-top:16px; padding:12px; background:var(--card); border-radius:var(--radius-sm); border-left:3px solid var(--em)">
        <div class="small">
          <strong>ğŸ“Š Module Stats:</strong>
          <span id="drain-stats" class="muted">Loading...</span>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Module B - Street-Tree Mycorrhizae
       
       WHAT: Tree health monitoring + mycorrhizal inoculation with care credits
       HOW IT WORKS:
       1. Sync official street tree inventory (DataSF + OpenTreeMap)
       2. AI/community assess tree health (drought stress, pest damage, etc.)
       3. Micro-tasks posted: watering, mulching, fungal inoculation
       4. Task completion earns non-transferable Care Credits
       5. Credits unlock governance participation (weighted voting, proposal rights)
       
       GAMIFICATION:
       - Water tree: +10 XP, +0.5 Care Credit
       - Mycorrhizal inoculation: +30 XP, +2 Care Credits
       - Monthly tree champion: +200 XP, featured on leaderboard
       
       DATA FEEDS:
       - Street trees dataset (124k+ trees in SF)
       - Drought index (NOAA)
       - Urban heat island map (NASA LANDSAT)
       - Tree species database with care requirements
       
       SCIENTIFIC ACCURACY:
       Mycorrhizal fungi (ectomycorrhizae & arbuscular mycorrhizae) form symbiotic
       relationships with 90%+ of tree species, enhancing nutrient uptake,
       drought resistance, and carbon sequestration. This module gamifies
       evidence-based silviculture practices.
       
       EXPANSION PROMPT: "Add tree species recognition via mobile camera (TensorFlow.js),
       automated watering alerts based on soil moisture sensors (IoT integration),
       carbon sequestration calculator showing cumulative impact, tree adoption
       program where citizens become long-term stewards, seasonal pruning guides"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="card" id="module-trees">
      <h3>ğŸŒ³ Streetâ€‘Tree Mycorrhizae (Care Credits)</h3>
      <div class="flex" style="margin-bottom:12px">
        <span class="pill small">Schema: <code class="mono">mycelial.treecare.v1</code></span>
        <span class="pill small">Feeds: trees, drought, heat islands</span>
        <span class="pill small success">+10-30 XP per task</span>
      </div>

      <details>
        <summary>ğŸ“– Concept & Workflow</summary>
        <div style="padding:12px 0">
          <p>
            San Francisco's 124,000+ street trees are critical infrastructure for carbon sequestration, urban cooling, and community wellbeing. 
            This module transforms tree care into a rewarded civic practice, enhanced by mycorrhizal science.
          </p>

          <h4>The Science: Why Mycorrhizae Matter</h4>
          <p class="small">
            Mycorrhizal fungi form underground networks connecting tree roots, enabling nutrient sharing and drought resilience. 
            By inoculating urban trees with native fungal spores, we can boost survival rates 40-60% while reducing water needs. 
            This is <em>evidence-based ecology</em> meets <em>participatory action</em>.
          </p>

          <h4>Task Types:</h4>
          <ul style="margin-left:20px">
            <li><strong>ğŸš° Watering:</strong> 5-10 gal for young/stressed trees (+10 XP, +0.5 Credit)</li>
            <li><strong>ğŸŒ± Mulching:</strong> Apply 2-4" organic mulch ring (+15 XP, +1 Credit)</li>
            <li><strong>ğŸ„ Mycorrhizal Inoculation:</strong> Apply spore mix to root zone (+30 XP, +2 Credits)</li>
            <li><strong>ğŸ“¸ Health Monitoring:</strong> Photo documentation + notes (+8 XP, +0.3 Credit)</li>
            <li><strong>ğŸ”§ Maintenance:</strong> Stake adjustment, guard repair (+12 XP, +0.7 Credit)</li>
          </ul>

          <h4>Smart Prioritization:</h4>
          <ul style="margin-left:20px">
            <li>Drought-stressed trees flagged automatically (NOAA index + heat map)</li>
            <li>High-traffic streets prioritized for air quality impact</li>
            <li>Young trees (<5 years) get 1.5x XP multiplier (critical establishment period)</li>
            <li>Rare/heritage species marked for special attention</li>
          </ul>

          <h4>Care Credits = Governance Power:</h4>
          <p class="small">
            Non-transferable Care Credits accumulate as reputation. Once you earn 10+ credits, 
            you can participate in municipal tree policy decisions (budget allocation, species selection, etc.). 
            This creates <em>earned governance</em>â€”those who care for the commons help steer it.
          </p>

          <h4>Achievements:</h4>
          <ul style="margin-left:20px">
            <li>ğŸŒ± <strong>Seedling Steward:</strong> Care for 5 trees (+75 XP)</li>
            <li>ğŸŒ³ <strong>Canopy Champion:</strong> 50 trees cared for (+500 XP, featured profile)</li>
            <li>ğŸ„ <strong>Myco-Master:</strong> Inoculate 20 trees (+400 XP, rare title)</li>
            <li>ğŸ† <strong>Grove Guardian:</strong> 1 year consecutive care streak (+1000 XP, permanent badge)</li>
          </ul>
        </div>
      </details>

      <div class="grid cols-3" style="margin-top:16px">
        <button class="pill primary" data-action="sync-trees" title="Earn +15 XP on first sync">
          ğŸ”„ Sync Trees
        </button>
        <button class="pill" data-action="nearby-tasks">
          ğŸ“ Nearby Tasks
        </button>
        <button class="pill" data-action="issue-credit">
          ğŸ–ï¸ Issue Care Credit
        </button>
      </div>

      <div style="margin-top:16px; padding:12px; background:var(--card); border-radius:var(--radius-sm); border-left:3px solid var(--ok)">
        <div class="small">
          <strong>ğŸŒ³ Trees in Cache:</strong> <span id="tree-cache-count" class="em">0</span> â€¢ 
          <strong>Care Credits Issued:</strong> <span id="care-credits-total" class="em">0</span>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Module C - Myco-Compost Exchange
       
       WHAT: P2P organic waste marketplace with DAO-routed fees
       HOW IT WORKS:
       1. Households post "supply" orders (X lbs/week compostables)
       2. Micro-haulers bid on routes (optimize for density)
       3. Urban farms post "demand" for finished compost
       4. Smart contract escrows payment, releases on delivery confirmation
       5. 2% transaction fee flows to city commons fund (DAO-governed)
       
       GAMIFICATION:
       - Post supply order: +5 XP
       - Complete pickup: +12 XP (both household & hauler)
       - Divert 100 lbs from landfill: "Waste Warrior" achievement (+80 XP)
       
       ECONOMIC MODEL:
       - Households: $5-15/month (cheaper than trash service)
       - Haulers: $25-40/hour (gig economy living wage)
       - Farms: $8-12/cubic yard finished compost (market rate)
       - Commons fund: $0.10-0.30 per transaction (self-funding public goods)
       
       ENVIRONMENTAL IMPACT:
       SF sends ~600 tons/day organics to landfills = 200k tons/year.
       Methane from decomposition = 500k tons CO2eq/year.
       This module can divert 10-30% within 2 years (proven by pilot data).
       
       EXPANSION PROMPT: "Add route optimization AI (TSP solver), real-time
       hauler GPS tracking with ETA, odor complaints reputation system,
       compost quality testing results (NPK ratios), carbon offset calculator,
       integration with existing municipal compost programs, seasonal demand
       predictions (spring planting rush)"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="card" id="module-compost">
      <h3>â™»ï¸ Mycoâ€‘Compost Exchange (DAOâ€‘routed)</h3>
      <div class="flex" style="margin-bottom:12px">
        <span class="pill small">Schema: <code class="mono">mycelial.exchange.v1</code></span>
        <span class="pill small">Settlement: ERC20 / Solana Program</span>
        <span class="pill small success">+5-12 XP per order</span>
      </div>

      <details>
        <summary>ğŸ“– Concept & Workflow</summary>
        <div style="padding:12px 0">
          <p>
            Transform SF's 200,000 tons/year of organic waste from climate liability into regenerative resource. 
            This module creates a decentralized marketplace connecting households, haulers, and urban farmsâ€”no middleman extraction.
          </p>

          <h4>Three-Sided Market:</h4>
          <ol style="margin-left:20px">
            <li>
              <strong>ğŸ  Supply Side (Households):</strong>
              Post weekly availability (3-25 lbs/week). Set pickup preferences (day/time). 
              Pay $5-15/month (auto-debit or crypto). Earn XP for consistency.
            </li>
            <li>
              <strong>ğŸšš Hauler Side (Micro-logistics):</strong>
              Claim routes via auction or fixed pricing. Algorithm optimizes density (minimize miles/lb). 
              Earn $25-40/hour. Reputation system for reliability/friendliness.
            </li>
            <li>
              <strong>ğŸŒ¾ Demand Side (Urban Farms):</strong>
              Post compost needs (cubic yards, delivery schedule). Pay market rate ($8-12/cy). 
              Quality tiers (basic/premium/mycorrhizal-enhanced). Farm-direct pickup option.
            </li>
          </ol>

          <h4>Smart Contract Escrow:</h4>
          <ul style="margin-left:20px">
            <li>Household payment held in contract until hauler confirms pickup</li>
            <li>Hauler payment released when farm confirms delivery (or 7-day timer)</li>
            <li>2% fee auto-routed to city commons DAO (public goods fund)</li>
            <li>Dispute resolution via multi-sig arbiter council (community-elected)</li>
          </ul>

          <h4>Commons Fund Governance:</h4>
          <p class="small">
            The 2% transaction fee accumulates in a transparent DAO treasury. Care Credit holders (10+ credits) 
            can propose uses: bike lane maintenance, tool libraries, community fridges, etc. 
            Quarterly votes allocate funds. This creates <em>programmable taxation</em> where the community directly steers public investment.
          </p>

          <h4>Environmental Impact Calculator:</h4>
          <div style="background:var(--card); padding:12px; border-radius:var(--radius-sm); margin:12px 0">
            <div class="small mono">
              <strong>Your Contributions:</strong><br>
              Organic Waste Diverted: <span id="compost-lbs" class="em">0</span> lbs<br>
              Methane Avoided: <span id="compost-methane" class="em">0</span> kg COâ‚‚eq<br>
              Soil Created: <span id="compost-soil" class="em">0</span> cubic feet
            </div>
          </div>

          <h4>Achievements:</h4>
          <ul style="margin-left:20px">
            <li>â™»ï¸ <strong>First Cycle:</strong> Complete first compost pickup (+20 XP)</li>
            <li>ğŸ—‘ï¸ <strong>Waste Warrior:</strong> Divert 100 lbs from landfill (+80 XP)</li>
            <li>ğŸšš <strong>Route Master:</strong> Haulers: complete 50 pickups (+300 XP)</li>
            <li>ğŸŒ¾ <strong>Soil Alchemist:</strong> Farms: accept 100 cubic yards (+500 XP, featured)</li>
          </ul>
        </div>
      </details>

      <div class="grid cols-3" style="margin-top:16px">
        <button class="pill primary" data-action="open-orderbook" title="Browse active orders">
          ğŸ“Š Order Book
        </button>
        <button class="pill" data-action="new-order">
          â• Create Order
        </button>
        <button class="pill" data-action="governance">
          ğŸ›ï¸ DAO Governance
        </button>
      </div>

      <div style="margin-top:16px; padding:12px; background:var(--card); border-radius:var(--radius-sm); border-left:3px solid var(--warn)">
        <div class="small">
          <strong>ğŸ“ˆ Market Stats:</strong>
          <span id="compost-stats" class="muted">Active Orders: 0 â€¢ Commons Fund: $0</span>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Module D - Mycelial 311 (Transparent Case Routing)
       
       WHAT: Enhanced 311 system with blockchain audit trail & bounties
       HOW IT WORKS:
       1. Citizens report issues (potholes, graffiti, etc.) via standard 311
       2. Cases auto-posted to transparent ledger (IPFS + local cache)
       3. For eligible cases, bounties posted (city budget + community fund)
       4. Licensed contractors OR verified community members can claim
       5. Photo verification by requestor closes case, releases payment
       
       GAMIFICATION:
       - Report issue: +8 XP
       - Fix claimed issue: +20 XP (verified community member)
       - Close 5 cases as requestor: "Civic Sentinel" achievement (+100 XP)
       
       TRANSPARENCY INNOVATION:
       Traditional 311 is opaque: "your request was forwarded to X department."
       This version shows: assigned dept, estimated timeline, bounty amount (if any),
       all case updates with timestamps, cryptographic proof of completion.
       
       EXPANSION PROMPT: "Add priority voting (stake Care Credits to bump urgent issues),
       case status notifications via SMS/email, integration with city work order systems,
       ML-based duplicate detection, geospatial clustering to identify systemic problems
       (e.g., recurring potholes = road reconstruction needed), sentiment analysis on
       case descriptions to flag community frustration hotspots"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="card" id="module-311">
      <h3>ğŸ“ Mycelial 311 (Transparent Case Routing)</h3>
      <div class="flex" style="margin-bottom:12px">
        <span class="pill small">Schema: <code class="mono">mycelial.311.v1</code></span>
        <span class="pill small">Feed: DataSF 311 API</span>
        <span class="pill small success">+8-20 XP per case</span>
      </div>

      <details>
        <summary>ğŸ“– Concept & Workflow</summary>
        <div style="padding:12px 0">
          <p>
            San Francisco's 311 system receives 1M+ requests/year. This enhanced version adds transparency, 
            community participation, and blockchain-verified completionâ€”transforming complaints into civic action opportunities.
          </p>

          <h4>Enhanced Features vs. Traditional 311:</h4>
          <table style="width:100%; font-size:.85rem; margin:12px 0">
            <tr style="background:var(--accent)">
              <th style="padding:8px; text-align:left">Feature</th>
              <th style="padding:8px; text-align:left">Traditional 311</th>
              <th style="padding:8px; text-align:left">Mycelial 311</th>
            </tr>
            <tr>
              <td style="padding:8px">Transparency</td>
              <td style="padding:8px; color:var(--bad)">Opaque "forwarded to dept"</td>
              <td style="padding:8px; color:var(--ok)">Full audit trail on IPFS</td>
            </tr>
            <tr style="background:var(--card)">
              <td style="padding:8px">Community Action</td>
              <td style="padding:8px; color:var(--bad)">Not supported</td>
              <td style="padding:8px; color:var(--ok)">Bounties for eligible cases</td>
            </tr>
            <tr>
              <td style="padding:8px">Verification</td>
              <td style="padding:8px; color:var(--warn)">Dept self-reports</td>
              <td style="padding:8px; color:var(--ok)">Requestor + photo proof</td>
            </tr>
            <tr style="background:var(--card)">
              <td style="padding:8px">Prioritization</td>
              <td style="padding:8px; color:var(--warn)">FIFO or opaque triage</td>
              <td style="padding:8px; color:var(--ok)">Community voting (Care Credits)</td>
            </tr>
          </table>

          <h4>Case Lifecycle:</h4>
          <ol style="margin-left:20px">
            <li><strong>Report:</strong> Citizen submits via web/mobile/phone (+8 XP)</li>
            <li><strong>Triage:</strong> AI + city staff categorize, assign priority & bounty (if eligible)</li>
            <li><strong>Claim:</strong> Dept or verified community member claims case</li>
            <li><strong>Work:</strong> Resolution work documented with timestamped photos</li>
            <li><strong>Verify:</strong> Requestor confirms completion via photo review</li>
            <li><strong>Close:</strong> Payment released, case closed on-chain (+20 XP for claimant)</li>
          </ol>

          <h4>Eligible Bounty Cases:</h4>
          <ul style="margin-left:20px">
            <li>Graffiti removal (small, <50 sq ft): $15-30</li>
            <li>Pothole filling (minor): $25-40</li>
            <li>Litter cleanup (5+ bags): $20-35</li>
            <li>Abandoned vehicle tagging: $10</li>
            <li>Tree trimming (sidewalk clearance): $30-60</li>
          </ul>

          <h4>Systemic Problem Detection:</h4>
          <p class="small">
            ML clustering identifies recurring issues in same locations. Example: if 10+ pothole reports 
            filed on same street within 3 months, system flags for full road reconstruction assessment. 
            This turns individual complaints into <em>evidence for policy change</em>.
          </p>

          <h4>Achievements:</h4>
          <ul style="margin-left:20px">
            <li>ğŸ“¢ <strong>First Voice:</strong> Report first 311 case (+15 XP)</li>
            <li>ğŸ”§ <strong>Community Fixer:</strong> Resolve 5 bounty cases (+150 XP)</li>
            <li>ğŸ‘ï¸ <strong>Civic Sentinel:</strong> Report + verify 20 cases (+400 XP)</li>
          </ul>
        </div>
      </details>

      <div class="grid cols-3" style="margin-top:16px">
        <button class="pill primary" data-action="report-311">
          ğŸ“ Report Issue
        </button>
        <button class="pill" data-action="view-311-map">
          ğŸ—ºï¸ Case Map
        </button>
        <button class="pill" data-action="claim-bounty">
          ğŸ’° Claim Bounty
        </button>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Module E - Neighborhood Resilience Hubs
       
       WHAT: Decentralized emergency preparedness + mutual aid networks
       HOW IT WORKS:
       1. Neighborhoods self-organize into resilience pods (20-50 households)
       2. Pods inventory resources: generators, first aid, tools, skills
       3. Emergency plans co-created, stored locally + IPFS backup
       4. During crises (earthquake, fire, blackout), pods coordinate autonomously
       5. Successful activation earns pod-wide reputation + funding priority
       
       GAMIFICATION:
       - Join pod: +10 XP
       - Contribute resource: +15 XP
       - Lead drill: +40 XP
       - Activate during real emergency: +200 XP (all pod members)
       
       REAL-WORLD PRECEDENT:
       Based on Seattle's Hub model + Transition Town principles. After major 
       disasters (Katrina, Fukushima, Maria), mutual aid networks out-performed
       centralized emergency response in first 72 hours. This module formalizes
       and gamifies that community resilience.
       
       EXPANSION PROMPT: "Add skill-sharing marketplace (who knows first aid, 
       welding, amateur radio?), emergency drill scheduler with reminders,
       resource-sharing protocols (generator loan agreements), integration with
       city emergency broadcast system, pet/elderly/disabled registry for
       priority check-ins, ham radio integration for off-grid comms"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="card" id="module-resilience">
      <h3>ğŸ˜ï¸ Neighborhood Resilience Hubs</h3>
      <div class="flex" style="margin-bottom:12px">
        <span class="pill small">Schema: <code class="mono">mycelial.resilience.v1</code></span>
        <span class="pill small">Backup: IPFS + Local Mesh</span>
        <span class="pill small success">+10-200 XP</span>
      </div>

      <details>
        <summary>ğŸ“– Concept & Workflow</summary>
        <div style="padding:12px 0">
          <p>
            When disaster strikes, centralized systems fail. Decentralized resilience hubs empower neighborhoods 
            to self-organize, share resources, and coordinate mutual aidâ€”complementing (not replacing) official emergency response.
          </p>

          <h4>Why Decentralized Resilience?</h4>
          <p class="small">
            After Hurricane Katrina, volunteer networks fed more people in week 1 than FEMA. 
            After Fukushima, local ham radio operators coordinated rescues when cell towers failed. 
            After Hurricane Maria, community kitchens kept Puerto Rico alive for months. 
            This module <em>operationalizes</em> that proven community capacity.
          </p>

          <h4>Pod Formation:</h4>
          <ul style="margin-left:20px">
            <li>20-50 households per pod (walkable distance, ~2-3 city blocks)</li>
            <li>At least 3 pod coordinators (elected, 6-month terms)</li>
            <li>Consensus-based decision making with fallback voting</li>
            <li>Pods federate into district-level networks for resource sharing</li>
          </ul>

          <h4>Resource Inventory (Example):</h4>
          <div style="background:var(--card); padding:12px; border-radius:var(--radius-sm); margin:12px 0; font-size:.85rem">
            <strong>Hayes Valley Pod 7A Inventory:</strong><br>
            âš¡ Generators: 3 (5kW, 3kW, 2kW portable)<br>
            ğŸ’§ Water Storage: 240 gallons (6 households with 55gal barrels)<br>
            ğŸ¥ First Aid Trained: 12 residents (CPR, Stop the Bleed, Wilderness Medicine)<br>
            ğŸ› ï¸ Tools: Chainsaws (2), bolt cutters (4), ladders (8), fire extinguishers (42)<br>
            ğŸ“» Comms: 5 ham radio operators, 1 satellite phone<br>
            ğŸ² Community Kitchen: 1 large camp stove, 200 meals/day capacity<br>
            ğŸš— Vehicles: 8 with >Â¾ tank gas policy, 2 trucks for debris removal
          </div>

          <h4>Emergency Protocols:</h4>
          <ol style="margin-left:20px">
            <li><strong>Immediate (0-6 hours):</strong> Welfare check-ins, damage assessment, triage</li>
            <li><strong>Short-term (6-72 hours):</strong> Community kitchen, shelter coordination, medical aid</li>
            <li><strong>Medium-term (3-30 days):</strong> Supply runs, debris removal, liaison with city services</li>
          </ol>

          <h4>Drill Types:</h4>
          <ul style="margin-left:20px">
            <li>ğŸ”¥ <strong>Fire Evacuation:</strong> Practice muster points, roll call (2x/year)</li>
            <li>ğŸŒŠ <strong>Tsunami/Flood:</strong> Evacuation routes to high ground (coastal pods)</li>
            <li>ğŸ’¥ <strong>Earthquake:</strong> Drop/cover, gas shutoff, search & rescue basics (1x/year)</li>
            <li>âš« <strong>Blackout:</strong> Generator deployment, food preservation, comms check (1x/year)</li>
          </ul>

          <h4>Achievements:</h4>
          <ul style="margin-left:20px">
            <li>ğŸ¤ <strong>Pod Joiner:</strong> Join resilience pod (+10 XP)</li>
            <li>ğŸ“¦ <strong>Resource Contributor:</strong> Add 3+ items to inventory (+40 XP)</li>
            <li>ğŸ“ <strong>Drill Leader:</strong> Organize pod drill (+60 XP)</li>
            <li>ğŸš¨ <strong>Crisis Responder:</strong> Activate during real emergency (+200 XP, all pod members)</li>
            <li>ğŸ† <strong>Resilience Steward:</strong> 2 years active pod membership (+500 XP, permanent badge)</li>
          </ul>
        </div>
      </details>

      <div class="grid cols-3" style="margin-top:16px">
        <button class="pill primary" data-action="join-pod">
          ğŸ˜ï¸ Join Pod
        </button>
        <button class="pill" data-action="view-resources">
          ğŸ“¦ View Resources
        </button>
        <button class="pill" data-action="schedule-drill">
          ğŸ“… Schedule Drill
        </button>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Module F - Participatory Budgeting
       
       WHAT: Direct democracy for discretionary city spending (1-5% of budget)
       HOW IT WORKS:
       1. City allocates X% of discretionary budget for participatory process
       2. Residents (w/ 5+ Care Credits) propose projects (<$500k each)
       3. Proposals vetted for feasibility (legal, engineering, cost)
       4. Community votes using quadratic voting (Care Credits = voice)
       5. Top-voted projects funded, tracked publicly, evaluated post-completion
       
       GAMIFICATION:
       - Submit proposal: +25 XP
       - Vote: +5 XP
       - Funded proposal: +500 XP (proposer)
       - Successful project completion: +1000 XP (proposer + community)
       
       EVIDENCE BASE:
       Participatory budgeting has been piloted in 7000+ cities worldwide.
       NYC's $32M PB process (2011-2020) showed 50% higher satisfaction vs.
       traditional capital planning. Porto Alegre (Brazil) pioneered model in 1989.
       
       EXPANSION PROMPT: "Add project impact metrics (jobs created, tons CO2 avoided,
       people served), comparison to traditional procurement costs, multi-year
       tracking of proposal outcomes, delegation system (lend voting power to
       trusted community members), quadratic funding matches for high-consensus
       low-controversy projects"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="card" id="module-budget">
      <h3>ğŸ’° Participatory Budgeting</h3>
      <div class="flex" style="margin-bottom:12px">
        <span class="pill small">Schema: <code class="mono">mycelial.budget.v1</code></span>
        <span class="pill small">Voting: Quadratic (Care Credit weighted)</span>
        <span class="pill small success">+5-1000 XP</span>
      </div>

      <details>
        <summary>ğŸ“– Concept & Workflow</summary>
        <div style="padding:12px 0">
          <p>
            What if residents directly decided how to spend public money? Participatory budgeting (PB) makes this real, 
            transforming abstract democracy into tangible community investment. This module uses Care Credits to ensure 
            those who contribute to the commons have strongest voice.
          </p>

          <h4>The Process (Annual Cycle):</h4>
          <ol style="margin-left:20px">
            <li><strong>Jan-Feb: Ideation</strong> â€” Community brainstorms needs (town halls, online forums)</li>
            <li><strong>Mar-Apr: Proposal Dev</strong> â€” Residents develop full proposals (budget, timeline, impact)</li>
            <li><strong>May: Vetting</strong> â€” City staff assess feasibility (legal, engineering, cost estimates)</li>
            <li><strong>Jun-Jul: Campaigning</strong> â€” Proposers present at community events, create materials</li>
            <li><strong>Aug: Voting</strong> â€” All residents vote (quadratic formula: cost = votesÂ²)</li>
            <li><strong>Sep: Results</strong> â€” Top-voted projects funded, contracts issued</li>
            <li><strong>Oct-Dec: Implementation</strong> â€” Projects executed, progress tracked publicly</li>
          </ol>

          <h4>Quadratic Voting Explained:</h4>
          <p class="small">
            Instead of 1-person-1-vote, quadratic voting lets you allocate your Care Credits across multiple proposals. 
            The cost is quadratic: 1 vote = 1 credit, 2 votes = 4 credits, 3 votes = 9 credits, etc. 
            This balances <em>preference intensity</em> (you can really support something) with <em>cost</em> (can't dominate everything). 
            Prevents tyranny of majority while respecting passionate minorities.
          </p>

          <h4>Example Budget (SF, 1% of $14B = $140M/year):</h4>
          <div style="background:var(--card); padding:12px; border-radius:var(--radius-sm); margin:12px 0; font-size:.85rem">
            <strong>2025 PB Cycle â€” $140M Available</strong><br><br>
            <strong>Winning Projects (top 20):</strong><br>
            1. Expand Mission bike lanes (23,450 votes) â€” $8.2M<br>
            2. Install 500 public EV chargers (19,200 votes) â€” $12M<br>
            3. Renovate Balboa Park playground (18,900 votes) â€” $3.5M<br>
            4. Free public restrooms in Tenderloin (16,800 votes) â€” $5.8M<br>
            5. Community solar on public buildings (15,400 votes) â€” $22M<br>
            ...<br>
            20. Chinatown cultural center repairs (8,200 votes) â€” $4.1M<br><br>
            <strong>Total Allocated:</strong> $138.7M (98.9% of budget)
          </div>

          <h4>Why Care Credits Matter:</h4>
          <p class="small">
            Anyone can vote, but Care Credits amplify voice. This creates <em>earned influence</em>â€”those who maintain trees, 
            fix drains, organize resilience pods get more say in budget priorities. It's not pay-to-play (credits are 
            non-transferable), it's <em>contribute-to-steer</em>. This aligns incentives: the commons is shaped by those who care for it.
          </p>

          <h4>Achievements:</h4>
          <ul style="margin-left:20px">
            <li>ğŸ—³ï¸ <strong>First Vote:</strong> Cast votes in PB cycle (+10 XP)</li>
            <li>ğŸ“ <strong>Proposer:</strong> Submit full proposal (+50 XP)</li>
            <li>ğŸ† <strong>Funded!</strong> Your proposal wins funding (+500 XP + featured profile)</li>
            <li>âœ… <strong>Delivered:</strong> Funded project completes on-time/budget (+1000 XP, legendary status)</li>
          </ul>
        </div>
      </details>

      <div class="grid cols-3" style="margin-top:16px">
        <button class="pill primary" data-action="browse-proposals">
          ğŸ“‹ Browse Proposals
        </button>
        <button class="pill" data-action="submit-proposal">
          â• Submit Proposal
        </button>
        <button class="pill" data-action="vote-budget">
          ğŸ—³ï¸ Vote Now
        </button>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION DIVIDER: Technical Infrastructure
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <h2 class="section-title">ğŸ”§ Technical Infrastructure</h2>
    <p class="small muted" style="margin-bottom:24px">
      The modules above run on these shared primitives: smart contracts, data adapters, and governance rails. 
      All components are modular and swappableâ€”no vendor lock-in.
    </p>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Smart Contract Hooks
       
       WHAT: Minimal, auditable smart contract interfaces for on-chain actions
       HOW IT WORKS:
       - Intent Registry: Post civic action intents with IPFS evidence links
       - Care Credits: Non-transferable ERC-5192-like reputation tokens
       - Escrow: Hold payment until verification quorum confirms completion
       - DAO Treasury: Accumulate fees, disburse via governance votes
       
       CHAIN SUPPORT:
       - Ethereum/L2s (Optimism, Base, Arbitrum) via MetaMask/WalletConnect
       - Solana via Phantom
       - Future: Celestia, Cosmos, Polkadot
       
       SECURITY NOTES:
       - All contracts should be audited before mainnet deployment
       - Multi-sig required for treasury operations (3-of-5 minimum)
       - Emergency pause functionality for critical bugs
       - Upgrade path via proxy pattern (transparent, UUPS, or beacon)
       
       EXPANSION PROMPT: "Add Solidity code snippets for each contract, deploy
       scripts, gas optimization notes, event indexing for subgraph, ENS integration
       for human-readable addresses, Gnosis Safe UI integration, OpenZeppelin
       defender monitoring"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="card" id="contracts">
      <h3>âš™ï¸ Smartâ€‘Contract Hooks</h3>
      <p class="small muted">
        This UI calls generic endpoints so you can swap chains easily. Provide RPC/Web3 providers via the <code class="mono">#cfg</code> meta tag.
      </p>

      <details>
        <summary>ğŸ“– Contract Architecture</summary>
        <div style="padding:12px 0">
          <h4>Core Contracts:</h4>
          
          <h5>1. Intent Registry (Action Tracking)</h5>
          <pre class="mono small" style="white-space:pre-wrap; margin:8px 0">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

interface IIntentRegistry {
  event IntentPosted(
    address indexed author,
    bytes32 indexed id,
    string module,
    string dataURI,
    uint256 timestamp
  );
  
  function postIntent(
    string calldata module,
    string calldata dataURI
  ) external returns (bytes32 intentId);
  
  function getIntent(bytes32 id) external view returns (
    address author,
    string memory module,
    string memory dataURI,
    uint256 timestamp,
    bool verified
  );
}</pre>

          <h5>2. Care Credits (Non-Transferable Reputation)</h5>
          <pre class="mono small" style="white-space:pre-wrap; margin:8px 0">// ERC-5192 compliant (Soulbound Token)
interface ICivicCredit {
  event CreditIssued(
    address indexed recipient,
    uint256 amount,
    string memo,
    uint256 timestamp
  );
  
  function issue(
    address to,
    uint256 amount,
    string calldata memo
  ) external;
  
  function balanceOf(address account) external view returns (uint256);
  
  // Non-transferable: these revert
  function transfer(address to, uint256 amount) external returns (bool);
  function approve(address spender, uint256 amount) external returns (bool);
}</pre>

          <h5>3. Escrow Contract (Bounty Management)</h5>
          <pre class="mono small" style="white-space:pre-wrap; margin:8px 0">interface IBountyEscrow {
  enum Status { Open, Claimed, Verified, Disputed, Paid }
  
  event BountyCreated(bytes32 indexed bountyId, uint256 amount);
  event BountyClaimed(bytes32 indexed bountyId, address claimant);
  event BountyVerified(bytes32 indexed bountyId, address[] verifiers);
  event BountyPaid(bytes32 indexed bountyId, address recipient);
  
  function createBounty(
    string calldata description,
    uint256 amount,
    uint8 requiredVerifiers
  ) external payable returns (bytes32);
  
  function claimBounty(bytes32 bountyId) external;
  
  function verifyCompletion(
    bytes32 bountyId,
    string calldata evidenceURI
  ) external;
}</pre>

          <h5>4. DAO Treasury (Commons Fund)</h5>
          <pre class="mono small" style="white-space:pre-wrap; margin:8px 0">interface ICommonsDAO {
  event ProposalCreated(uint256 indexed id, string title, uint256 amount);
  event VoteCast(uint256 indexed proposalId, address voter, uint256 weight);
  event ProposalExecuted(uint256 indexed id);
  
  function propose(
    string calldata title,
    string calldata description,
    address recipient,
    uint256 amount,
    string calldata ipfsCID
  ) external returns (uint256 proposalId);
  
  function vote(uint256 proposalId, uint256 credits) external;
  
  function execute(uint256 proposalId) external;
}</pre>

          <h4>Deployment Addresses (Testnet):</h4>
          <div style="background:var(--card); padding:12px; border-radius:var(--radius-sm); margin:12px 0; font-size:.85rem">
            <strong>Base Sepolia (Testnet):</strong><br>
            IntentRegistry: <code>0x1234...5678</code><br>
            CivicCredit: <code>0xabcd...ef01</code><br>
            BountyEscrow: <code>0x9876...5432</code><br>
            CommonsDAO: <code>0xfedc...ba98</code><br><br>
            <em>Note: Replace with your deployed addresses. Never commit private keys to git.</em>
          </div>

          <h4>Gas Optimization Tips:</h4>
          <ul style="margin-left:20px; font-size:.85rem">
            <li>Use <code>calldata</code> instead of <code>memory</code> for external function strings</li>
            <li>Pack struct variables to fit in 32-byte slots</li>
            <li>Batch operations (e.g., issue credits to multiple users in one tx)</li>
            <li>Use events for historical data instead of storage when possible</li>
            <li>Consider L2s (Optimism, Base, Arbitrum) for 10-100x cheaper gas</li>
          </ul>
        </div>
      </details>

      <div class="grid cols-3" style="margin-top:16px">
        <button class="pill primary" data-action="evm-connect">
          ğŸ¦Š Connect EVM
        </button>
        <button class="pill" data-action="sol-connect">
          ğŸ‘» Connect Solana
        </button>
        <button class="pill" data-action="simulate">
          ğŸ§ª Simulate TX
        </button>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Data Adapters
       
       WHAT: Standardized interfaces to city open data + external APIs
       HOW IT WORKS:
       - Socrata (DataSF) adapter for SF Open Data Portal
       - NOAA/NWS for weather/climate data
       - IPFS for decentralized evidence storage
       - Local IndexedDB cache for offline resilience
       
       SUPPORTED DATASETS:
       - Street Trees (124k+ records)
       - 311 Cases (1M+/year)
       - Building permits
       - Crime incidents
       - Air quality (PurpleAir API)
       - Transit (SFMTA real-time)
       
       PRIVACY NOTES:
       - All API calls client-side (no server proxy tracking)
       - Location data coarsened before public display
       - Personal info never sent to external APIs without consent
       
       EXPANSION PROMPT: "Add GraphQL adapter for subgraph queries, WebSocket
       support for real-time feeds, rate limiting with exponential backoff,
       caching strategy (stale-while-revalidate), adapter for other cities
       (NYC, LA, Chicago), custom data source registration UI"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="card" id="adapters">
      <h3>ğŸ”Œ Data Adapters</h3>
      <p class="small muted">
        Configure datasets using the <span class="mono">#cfg</span> meta tag. Ships with Socrataâ€‘style adapter shells for DataSF.
      </p>

      <details>
        <summary>ğŸ“– Adapter Reference</summary>
        <div style="padding:12px 0">
          <h4>Available Adapters:</h4>

          <h5>1. DataSF (Socrata)</h5>
          <div style="background:var(--card); padding:12px; border-radius:var(--radius-sm); margin:8px 0; font-size:.85rem">
            <strong>Base URL:</strong> <code>https://data.sfgov.org/resource/</code><br>
            <strong>Format:</strong> JSON, CSV, XML<br>
            <strong>Auth:</strong> Optional app token for higher rate limits<br>
            <strong>Rate Limit:</strong> 1000 req/hour (unauthed), 10k/hour (with token)<br><br>
            
            <strong>Example Queries:</strong><br>
            <code>GET /resource/tkzw-k3nq.json?$limit=100</code> â€” Street trees<br>
            <code>GET /resource/vw6y-z8j6.json?$where=opened>'2024-01-01'</code> â€” 311 cases<br>
            <code>GET /resource/cuks-n6tp.json?$select=avg(score)</code> â€” Restaurant scores
          </div>

          <h5>2. NOAA/NWS (Weather)</h5>
          <div style="background:var(--card); padding:12px; border-radius:var(--radius-sm); margin:8px 0; font-size:.85rem">
            <strong>Base URL:</strong> <code>https://api.weather.gov</code><br>
            <strong>Auth:</strong> None required (public API)<br>
            <strong>Rate Limit:</strong> No official limit, be respectful<br><br>
            
            <strong>SF Station ID:</strong> KSFO (SFO Airport)<br>
            <strong>Example:</strong> <code>GET /stations/KSFO/observations/latest</code>
          </div>

          <h5>3. IPFS (Decentralized Storage)</h5>
          <div style="background:var(--card); padding:12px; border-radius:var(--radius-sm); margin:8px 0; font-size:.85rem">
            <strong>Public Gateways:</strong><br>
            - <code>https://ipfs.io/ipfs/{CID}</code><br>
            - <code>https://dweb.link/ipfs/{CID}</code><br>
            - <code>https://cloudflare-ipfs.com/ipfs/{CID}</code><br><br>
            
            <strong>Pinning Services:</strong><br>
            - Web3.Storage (free tier: 1TB)<br>
            - Pinata (free tier: 1GB)<br>
            - NFT.Storage (free for NFT metadata)
          </div>

          <h5>4. Custom Data Sources</h5>
          <p class="small">
            Add your own adapters by editing the <code>adapters</code> object in JavaScript.
            Follow the pattern: <code>async function(params) â†’ Promise&lt;data&gt;</code>
          </p>
          <pre class="mono small" style="white-space:pre-wrap; margin:8px 0">// Example: Add PurpleAir air quality
const adapters = {
  async airQuality(sensor_id) {
    const r = await fetch(
      `https://api.purpleair.com/v1/sensors/${sensor_id}`,
      {headers: {'X-API-Key': 'YOUR_KEY'}}
    );
    return r.json();
  }
};</pre>

          <h4>Caching Strategy:</h4>
          <ul style="margin-left:20px; font-size:.85rem">
            <li><strong>Hot data</strong> (311 cases): Cache 5 min, then refetch</li>
            <li><strong>Warm data</strong> (trees): Cache 24 hours</li>
            <li><strong>Cold data</strong> (historical): Cache 7 days</li>
            <li><strong>Static data</strong> (schemas): Cache indefinitely, version by hash</li>
          </ul>
        </div>
      </details>

      <div class="grid cols-3" style="margin-top:16px">
        <div class="small">
          <strong>Street Trees</strong><br>
          <code class="mono" style="font-size:.75rem">/resource/<span data-k="trees-key">tkzw-k3nq</span>.json</code>
        </div>
        <div class="small">
          <strong>311 Cases</strong><br>
          <code class="mono" style="font-size:.75rem">/resource/<span data-k="311-key">vw6y-z8j6</span>.json</code>
        </div>
        <div class="small">
          <strong>Weather (NOAA)</strong><br>
          <code class="mono" style="font-size:.75rem">/stations/KSFO</code>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Spatial Hotspots Map
       
       WHAT: Interactive map showing 311 cases, trees, and module-specific data
       HOW IT WORKS:
       - MapLibre GL JS (OSM-compatible, no API key needed)
       - Vector tiles from Carto (free tier)
       - GeoJSON overlays for custom data
       - Clustering for dense point datasets
       
       LAYERS:
       - Basemap: Carto Voyager (swappable to Positron, Dark Matter)
       - 311 Cases: Red circles, clustered
       - Street Trees: Green circles
       - Drains: Blue markers (custom icon)
       - Resilience Hubs: Purple polygons
       
       INTERACTION:
       - Click markers for popup details
       - Drag to pan, scroll to zoom
       - Filter by module, date range, status
       
       EXPANSION PROMPT: "Add heatmap layer for density, 3D building extrusions,
       draw tools for custom boundaries, route planning for haulers, isochrone
       visualizations (15-min walk radius), time-slider animation for 311 case
       evolution, export map as PNG/PDF"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <h2 class="section-title">ğŸ—ºï¸ Spatial Hotspots</h2>
    <section class="card" id="spatial">
      <div class="small muted" style="margin-bottom:12px">
        Drag/zoom to explore. Layers: 311 (last 24h), Street Trees sample, Module hotspots. 
        Uses Carto Voyager basemap via free vector tiles.
      </div>
      
      <div id="map" style="height:500px; border-radius:var(--radius-md); overflow:hidden; border:1px solid var(--accent); margin-bottom:16px"></div>

      <details style="margin-bottom:16px">
        <summary>ğŸ›ï¸ Map Controls & Layers</summary>
        <div style="padding:12px 0">
          <h4>Available Layers:</h4>
          <div class="grid cols-2" style="gap:8px; margin:12px 0">
            <label class="flex" style="cursor:pointer; padding:8px; background:var(--card); border-radius:var(--radius-sm)">
              <input type="checkbox" id="layer-311" checked style="margin-right:8px">
              <span>ğŸ“ 311 Cases (24h)</span>
            </label>
            <label class="flex" style="cursor:pointer; padding:8px; background:var(--card); border-radius:var(--radius-sm)">
              <input type="checkbox" id="layer-trees" checked style="margin-right:8px">
              <span>ğŸŒ³ Street Trees</span>
            </label>
            <label class="flex" style="cursor:pointer; padding:8px; background:var(--card); border-radius:var(--radius-sm)">
              <input type="checkbox" id="layer-drains" style="margin-right:8px">
              <span>ğŸŒŠ Storm Drains</span>
            </label>
            <label class="flex" style="cursor:pointer; padding:8px; background:var(--card); border-radius:var(--radius-sm)">
              <input type="checkbox" id="layer-hubs" style="margin-right:8px">
              <span>ğŸ˜ï¸ Resilience Hubs</span>
            </label>
          </div>

          <h4>Basemap Styles:</h4>
          <div class="grid cols-3" style="gap:8px">
            <button class="pill small" data-map-style="voyager">ğŸ—ºï¸ Voyager</button>
            <button class="pill small" data-map-style="positron">â˜€ï¸ Light</button>
            <button class="pill small" data-map-style="dark">ğŸŒ™ Dark</button>
          </div>
        </div>
      </details>

      <div class="grid cols-3">
        <button class="pill" data-action="map-refresh">
          ğŸ”„ Refresh Layers
        </button>
        <button class="pill" data-action="map-fit">
          ğŸ¯ Fit to Data
        </button>
        <button class="pill" data-action="map-export">
          ğŸ“¸ Export PNG
        </button>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Governance & Transparency
       
       WHAT: Public ledger, proposal system, multi-sig wallet info
       HOW IT WORKS:
       - All intents, credits, bounties logged to IndexedDB + IPFS
       - Proposals require 5+ Care Credits to submit
       - Multi-sig treasury (3-of-5 minimum) for fund disbursement
       - Quarterly audits with public reports
       
       TRANSPARENCY TOOLS:
       - Real-time ledger explorer (all actions visible)
       - Proposal voting history (who voted what)
       - Treasury balance + transaction log
       - Impact metrics dashboard (trees planted, waste diverted, etc.)
       
       EXPANSION PROMPT: "Add Etherscan/Basescan integration for on-chain
       verification, Dune Analytics dashboard embed, downloadable audit reports,
       multi-sig signer rotation ceremony, emergency pause mechanism with
       time-lock, governance forum integration (Discourse/Commonwealth)"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <h2 class="section-title">ğŸ›ï¸ Governance & Transparency</h2>
    <section class="card" id="governance">
      <h3>Public Accountability</h3>
      <p class="small">
        All actions, credits, and funds flow through transparent, auditable systems. 
        This section provides tools to verify integrity and participate in governance.
      </p>

      <h4 style="margin-top:16px">Core Principles:</h4>
      <ul style="margin-left:20px">
        <li>ğŸ“‹ <strong>Public Ledger:</strong> All intents, fulfillments, and disbursements visible to everyone</li>
        <li>ğŸ” <strong>Multi-Sig Treasury:</strong> 3-of-5 signatures required for fund movements</li>
        <li>ğŸ—³ï¸ <strong>Proposal System:</strong> Any resident with 5+ Care Credits can propose actions</li>
        <li>ğŸ“Š <strong>Impact Metrics:</strong> Quantified outcomes (trees saved, waste diverted, CO2 avoided)</li>
        <li>ğŸ” <strong>Quarterly Audits:</strong> Independent review of smart contracts and fund flows</li>
      </ul>

      <h4 style="margin-top:16px">Treasury Status:</h4>
      <div style="background:var(--card); padding:16px; border-radius:var(--radius-sm); margin:12px 0">
        <div class="grid cols-3" style="gap:16px">
          <div>
            <div class="small muted">Total Balance</div>
            <div class="mono" style="font-size:1.5rem; color:var(--em)" id="treasury-balance">$0</div>
          </div>
          <div>
            <div class="small muted">Allocated</div>
            <div class="mono" style="font-size:1.5rem; color:var(--warn)" id="treasury-allocated">$0</div>
          </div>
          <div>
            <div class="small muted">Available</div>
            <div class="mono" style="font-size:1.5rem; color:var(--ok)" id="treasury-available">$0</div>
          </div>
        </div>
      </div>

      <h4 style="margin-top:16px">Multi-Sig Signers:</h4>
      <div class="small mono" style="background:var(--card); padding:12px; border-radius:var(--radius-sm); margin:12px 0">
        1. <code>0x1234...5678</code> (City Treasurer)<br>
        2. <code>0xabcd...ef01</code> (Community Rep A)<br>
        3. <code>0x9876...5432</code> (Community Rep B)<br>
        4. <code>0xfedc...ba98</code> (Tech Steward)<br>
        5. <code>0x2468...1357</code> (Auditor)<br><br>
        <em class="muted">Signers rotate every 6 months via Care Credit-weighted election</em>
      </div>

      <div class="grid cols-3" style="margin-top:16px">
        <button class="pill primary" data-action="new-proposal">
          ğŸ“ New Proposal
        </button>
        <button class="pill" data-action="open-ledger">
          ğŸ“– Open Ledger
        </button>
        <button class="pill" data-action="export-manifest">
          ğŸ’¾ Export Manifest
        </button>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Integrity & Verification
       
       WHAT: Cryptographic hash of entire document for tamper detection
       HOW IT WORKS:
       - SHA-256 hash computed client-side every 5 seconds
       - Compare against expected hash (set by publisher)
       - Mismatch = warning (potential tampering or version drift)
       
       USAGE:
       1. Deploy your final index.html
       2. Compute hash: `cat index.html | shasum -a 256`
       3. Update data-expected-hash in #cfg meta tag
       4. Users see green checkmark if hash matches
       
       EXPANSION PROMPT: "Add GPG signature verification, Merkle tree for
       section-level integrity, blockchain anchor (post hash to Ethereum),
       content-addressing (IPFS CID), version history with diff viewer"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <h2 class="section-title">ğŸ”’ Integrity & Verification</h2>
    <section class="card" id="integrity-check">
      <h3>Document Integrity</h3>
      <p class="small">
        This banner shows a rolling SHA-256 hash of the current document. Compare against the expected hash 
        (set by publisher) to verify you're viewing the authentic, unmodified version.
      </p>

      <div style="background:var(--card); padding:16px; border-radius:var(--radius-sm); margin:16px 0; border-left:3px solid var(--em)">
        <div class="small"><strong>Current Hash:</strong></div>
        <div id="hash-line" class="mono small" style="word-break:break-all; margin:8px 0">Computing...</div>
        
        <div class="small"><strong>Expected Hash:</strong></div>
        <div class="mono small muted" style="word-break:break-all; margin:8px 0" id="expected-hash">
          Not set (update data-expected-hash in #cfg after deployment)
        </div>
        
        <div id="hash-status" class="small" style="margin-top:12px">
          <strong>Status:</strong> <span class="muted">Verifying...</span>
        </div>
      </div>

      <details>
        <summary>ğŸ›¡ï¸ Why This Matters</summary>
        <div style="padding:12px 0">
          <p class="small">
            In decentralized systems, you can't always trust the server. Cryptographic hashing lets you verify 
            that the code you're running matches what the publisher intendedâ€”no backdoors, no malicious modifications.
          </p>
          
          <h4>How to Verify Manually:</h4>
          <ol style="margin-left:20px; font-size:.85rem">
            <li>Download this HTML file</li>
            <li>Run: <code>shasum -a 256 index.html</code> (Mac/Linux) or <code>certutil -hashfile index.html SHA256</code> (Windows)</li>
            <li>Compare output to the expected hash above</li>
            <li>If match: âœ… Authentic. If mismatch: âš ï¸ Investigate</li>
          </ol>

          <h4>Future: Blockchain Anchoring</h4>
          <p class="small">
            We could post this hash to Ethereum every release, creating an immutable audit trail. 
            Anyone can then verify: "Is this the v2.1.3 published on 2025-10-15?" Cost: ~$5/anchor.
          </p>
        </div>
      </details>

      <div class="grid cols-3" style="margin-top:16px">
        <button class="pill" data-action="copy-hash">
          ğŸ“‹ Copy Hash
        </button>
        <button class="pill" data-action="verify-manual">
          ğŸ” Manual Verify
        </button>
        <button class="pill" data-action="anchor-eth">
          â›“ï¸ Anchor to Chain
        </button>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Schemas & Interoperability
       
       WHAT: JSON schemas for all module actions, enabling cross-city federation
       HOW IT WORKS:
       - Each module defines a JSON schema (JSONSchema Draft 7)
       - Actions serialize to these schemas before posting
       - Other cities can import/adapt schemas for their context
       - Enables data portability (export from SF, import to NYC)
       
       FEDERATION VISION:
       Imagine 100 cities using compatible mycelial modules. A resident who earns
       Care Credits in SF canport reputation to Oakland. A drain maintenance
       solution piloted in Seattle propagates to Portland. This requires SCHEMA STANDARDS.
       
       EXPANSION PROMPT: "Add schema validator (AJV), schema registry with
       versioning, migration tools for schema updates, example data for each
       schema, GraphQL schema generation, Protobuf compilation for efficient
       wire transfer, federation protocol spec (like ActivityPub for cities)"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <h2 class="section-title">ğŸ“ Schemas & Interoperability</h2>
    <section class="card" id="schemas">
      <h3>JSON Schema Library</h3>
      <p class="small">
        All module actions conform to these schemas, enabling data portability and cross-city federation. 
        Schemas are versioned (semver) and backward-compatible within major versions.
      </p>

      <details open>
        <summary>ğŸ“„ mycelial.action.v1 (Base Schema)</summary>
        <div style="padding:12px 0">
          <pre class="mono small" style="white-space:pre-wrap; max-height:400px; overflow-y:auto">{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mycelial.city/schemas/action.v1.json",
  "title": "Mycelial Action",
  "description": "Base schema for all civic actions in mycelial governance systems",
  "type": "object",
  "required": ["schema", "id", "module", "timestamp"],
  "properties": {
    "schema": {
      "type": "string",
      "enum": ["mycelial.action.v1"],
      "description": "Schema identifier and version"
    },
    "id": {
      "type": "string",
      "pattern": "^urn:action:[a-f0-9-]{36}$",
      "description": "Unique action identifier (UUIDv4)"
    },
    "module": {
      "type": "string",
      "enum": ["drains", "trees", "compost", "311", "resilience", "budget"],
      "description": "Module that generated this action"
    },
    "geo": {
      "type": "object",
      "required": ["lat", "lng"],
      "properties": {
        "lat": {"type": "number", "minimum": -90, "maximum": 90},
        "lng": {"type": "number", "minimum": -180, "maximum": 180},
        "accuracy": {"type": "number", "description": "meters"},
        "coarsened": {"type": "boolean", "description": "true if location rounded for privacy"}
      }
    },
    "evidence": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["type", "uri"],
        "properties": {
          "type": {"type": "string", "enum": ["photo", "video", "document", "signature"]},
          "uri": {"type": "string", "format": "uri", "description": "ipfs:// or https://"},
          "hash": {"type": "string", "description": "SHA-256 hash for verification"},
          "metadata_stripped": {"type": "boolean", "description": "EXIF/GPS removed"}
        }
      }
    },
    "proposer": {
      "type": "string",
      "description": "DID or address of action proposer",
      "pattern": "^(did:|0x)[a-zA-Z0-9:]+$"
    },
    "intent_cid": {
      "type": "string",
      "description": "IPFS CID of full intent document",
      "pattern": "^(Qm|bafy)[a-zA-Z0-9]{44,}$"
    },
    "fulfillment": {
      "type": "object",
      "properties": {
        "verifiers": {
          "type": "array",
          "items": {"type": "string", "description": "DID or address"}
        },
        "quorum": {"type": "integer", "minimum": 1, "description": "required verifier count"},
        "payout": {
          "type": "object",
          "properties": {
            "asset": {"type": "string", "description": "USDC, ETH, etc."},
            "amount": {"type": "number", "minimum": 0},
            "recipient": {"type": "string"}
          }
        }
      }
    },
    "privacy": {
      "type": "object",
      "properties": {
        "level": {"type": "string", "enum": ["public", "pseudonymous", "private"]},
        "notes": {"type": "string", "description": "privacy considerations"}
      }
    },
    "timestamp": {
      "type": "integer",
      "description": "Unix timestamp (seconds since epoch)"
    },
    "signature": {
      "type": "string",
      "description": "Cryptographic signature of action hash"
    }
  }
}</pre>
        </div>
      </details>

      <details>
        <summary>ğŸ“„ Other Module Schemas</summary>
        <div style="padding:12px 0">
          <p class="small muted">
            Each module extends the base <code>mycelial.action.v1</code> schema with domain-specific fields. 
            Full schema library available in the code below or via export.
          </p>
          <ul style="margin-left:20px; font-size:.85rem">
            <li><code>mycelial.treecare.v1</code> â€” adds tree_id, species, care_type</li>
            <li><code>mycelial.exchange.v1</code> â€” adds order_type, quantity, price</li>
            <li><code>mycelial.311.v1</code> â€” adds case_number, category, priority</li>
            <li><code>mycelial.resilience.v1</code> â€” adds pod_id, resource_type</li>
            <li><code>mycelial.budget.v1</code> â€” adds proposal_id, votes, funding_amount</li>
          </ul>
        </div>
      </details>

      <div class="grid cols-3" style="margin-top:16px">
        <button class="pill primary" data-action="save-schema">
          ğŸ’¾ Save to IndexedDB
        </button>
        <button class="pill" data-action="export-all-schemas">
          ğŸ“¦ Export All (.zip)
        </button>
        <button class="pill" data-action="validate-action">
          âœ… Validate Action
        </button>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOOLTIP: Analytics & Privacy
       
       WHAT: Opt-in analytics with daily email summaries (not real-time tracking)
       HOW IT WORKS:
       - All analytics client-side (no external trackers)
       - Events stored in IndexedDB: {action, timestamp, module, xp_gained}
       - Daily summary generated at midnight (local time)
       - Email sent to admin@planetaryrestorationarchive.com via mailto: (user's email client)
       - No PII collected (user can purge data anytime)
       
       PRIVACY GUARANTEES:
       - No cookies
       - No third-party scripts (except map tiles, which are public)
       - No IP logging
       - No fingerprinting
       - Data stays on device unless user explicitly emails
       
       EXPANSION PROMPT: "Add privacy dashboard showing all collected data,
       one-click purge button, export personal data as JSON, GDPR compliance
       checklist, consent management with granular opt-in/out, anonymization
       before aggregate reporting"
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <h2 class="section-title">ğŸ“Š Analytics & Privacy</h2>
    <section class="card" id="analytics">
      <h3>Privacy-First Analytics</h3>
      <p class="small">
        <strong>Zero-Harm Commitment:</strong> We collect minimal, anonymized usage data to improve the platform. 
        All data stays on your device. You control what (if anything) is shared.
      </p>

      <h4 style="margin-top:16px">What We Track (Client-Side Only):</h4>
      <ul style="margin-left:20px; font-size:.85rem">
        <li>âœ… Actions performed (sync trees, post intent, etc.) â€” <em>to calculate XP</em></li>
        <li>âœ… Module usage frequency â€” <em>to prioritize development</em></li>
        <li>âœ… Time spent on page â€” <em>to measure engagement</em></li>
        <li>âœ… Errors encountered â€” <em>to fix bugs</em></li>
        <li>âŒ <strong>Never:</strong> Your identity, location (beyond city-level), keystrokes, or clicks outside actions</li>
      </ul>

      <h4 style="margin-top:16px">Daily Summary Email (Opt-In):</h4>
      <p class="small">
        Enable this to send a daily summary to <code>admin@planetaryrestorationarchive.com</code> via your email client. 
        Summary includes aggregate stats only (no PII). Example:
      </p>
      <div style="background:var(--card); padding:12px; border-radius:var(--radius-sm); margin:12px 0; font-size:.85rem; font-family:var(--mono)">
        <strong>Daily Summary â€” 2025-10-15</strong><br><br>
        Total Actions: 47<br>
        Most Used Module: Trees (18 actions)<br>
        XP Earned: 342<br>
        Errors: 2 (details below)<br>
        Active Users (anonymized IDs): 12<br><br>
        Module Breakdown:<br>
        - Drains: 8<br>
        - Trees: 18<br>
        - Compost: 12<br>
        - 311: 6<br>
        - Resilience: 2<br>
        - Budget: 1
      </div>

      <div class="flex" style="margin:16px 0; padding:12px; background:var(--card); border-radius:var(--radius-sm); border-left:3px solid var(--warn)">
        <input type="checkbox" id="analytics-opt-in" style="margin-right:12px">
        <label for="analytics-opt-in" class="small">
          I consent to anonymized analytics collection and daily email summaries (opt-in, revocable anytime)
        </label>
      </div>

      <div class="grid cols-3" style="margin-top:16px">
        <button class="pill primary" data-action="view-my-data">
          ğŸ‘¤ View My Data
        </button>
        <button class="pill danger" data-action="purge-data">
          ğŸ—‘ï¸ Purge All Data
        </button>
        <button class="pill" data-action="export-analytics">
          ğŸ“Š Export Report
        </button>
      </div>
    </section>

  </main>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOOLTIP: Floating Overlays
     
     WHAT: XMR donation, chat launcher, theme switcher
     HOW TO USE: Fixed position, collapse/expand on click
     EXPECTED OUTCOME: Persistent access to support and community features
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <!-- XMR Donation Overlay -->
  <aside class="xmr" aria-label="Support overlay">
    <button id="xmr-toggle" title="Support this work">â˜¯ï¸ Support</button>
    <div class="panel" id="xmr-panel">
      <div class="small muted">Support Planetary Restoration Archive:</div>
      <div class="addr" id="xmr-addr">
        47LcEP5RYbVMCMXNURuRjq8qHJNeF2aZ339Bp45MYhmMES5Cc61jMZa59BBdY137EyJMqLfQFBvesV6jLjyCFsBVQYftWde
      </div>
      <div class="small" style="margin-top:8px">
        <a href="https://planetaryrestorationarchive.com/crypto/xmr" target="_blank" rel="noopener">Learn about XMR contributions â†’</a>
      </div>
      <button class="pill small" data-action="copy-xmr" style="margin-top:8px; width:100%">ğŸ“‹ Copy Address</button>
    </div>
  </aside>

  <!-- tlk.io chat launcher -->
  <aside class="chat-launch" aria-label="Community chat">
    <button id="chat-open" title="Open community chat">ğŸ’¬ Chat</button>
  </aside>
  <div id="chat-frame" style="display:none; position:fixed; left:12px; bottom:60px; width:min(92vw, 420px); height:60vh; z-index:70; border:1px solid var(--accent-bright); border-radius:var(--radius-md); overflow:hidden; box-shadow:var(--shadow-lg); background:var(--panel)">
    <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 12px; background:var(--accent); border-bottom:1px solid var(--accent-bright)">
      <span class="small" style="font-weight:600">Community Chat</span>
      <button id="chat-close" style="background:transparent; border:none; color:var(--ink); font-size:1.2rem; cursor:pointer; padding:4px 8px">Ã—</button>
    </div>
    <iframe id="chat-iframe" style="width:100%; height:calc(100% - 40px); border:none"></iframe>
  </div>

  <!-- Integrity banner (fixed top-right) -->
  <div class="integrity" id="integrity-banner">
    ğŸ”’ hash: computing...
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOOLTIP: Modals
     
     WHAT: Overlays for proposals, settings, achievements, help
     HOW TO USE: Click backdrop or close button to dismiss
     EXPECTED OUTCOME: Contextual interfaces without page navigation
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <!-- Modal: Proposal Draft -->
  <div id="modal-proposal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“ New Proposal</h2>
        <button class="modal-close" data-action="modal-close">Ã—</button>
      </div>
      <div class="modal-body">
        <label>
          <span>Title</span>
          <input id="prop-title" placeholder="e.g., Install 20 bioswales in Mission District" />
        </label>
        <label>
          <span>Module</span>
          <select id="prop-module">
            <option value="drains">Mycoâ€‘Storm Drains</option>
            <option value="trees">Streetâ€‘Tree Mycorrhizae</option>
            <option value="compost">Mycoâ€‘Compost Exchange</option>
            <option value="311">Mycelial 311</option>
            <option value="resilience">Resilience Hubs</option>
            <option value="budget">Participatory Budgeting</option>
          </select>
        </label>
        <label>
          <span>Summary</span>
          <textarea id="prop-summary" rows="6" placeholder="Describe the proposal, its goals, and expected impact..."></textarea>
        </label>
        <label>
          <span>Funding Request (USD)</span>
          <input id="prop-amount" type="number" min="0" step="1000" placeholder="0" />
        </label>
        <div class="grid cols-3" style="margin-top:20px">
          <button class="pill success" data-action="prop-save">ğŸ’¾ Save Local</button>
          <button class="pill primary" data-action="prop-pin">ğŸ“Œ Pin to IPFS</button>
          <button class="pill" data-action="modal-close">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Settings -->
  <div id="modal-settings" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">âš™ï¸ Settings</h2>
        <button class="modal-close" data-action="modal-close">Ã—</button>
      </div>
      <div class="modal-body">
        <p class="small muted">
          Configure API tokens and preferences. All data stored locally in IndexedDB (never sent to servers).
        </p>
        <label>
          <span>Web3.Storage Token (optional, for IPFS pinning)</span>
          <input id="w3s-token" type="password" placeholder="eyJhbGc..." />
        </label>
        <label>
          <span>Preferred Language</span>
          <select id="pref-lang">
            <option value="en">English</option>
            <option value="es">EspaÃ±ol</option>
            <option value="zh">ä¸­æ–‡</option>
          </select>
        </label>
        <label class="flex" style="margin:16px 0">
          <input type="checkbox" id="pref-notifications" style="margin-right:8px">
          <span class="small">Enable browser notifications for quests & achievements</span>
        </label>
        <div class="grid cols-3" style="margin-top:20px">
          <button class="pill success" data-action="settings-save">ğŸ’¾ Save</button>
          <button class="pill danger" data-action="settings-clear">ğŸ—‘ï¸ Clear All</button>
          <button class="pill" data-action="modal-close">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Help & Tutorial -->
  <div id="modal-help" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">â“ Help & Tutorial</h2>
        <button class="modal-close" data-action="modal-close">Ã—</button>
      </div>
      <div class="modal-body">
        <h3>ğŸ® Getting Started</h3>
        <ol style="margin-left:20px">
          <li>Explore the <strong>6 modules</strong> to see what civic actions you can take</li>
          <li>Complete actions to earn <strong>XP</strong> and level up</li>
          <li>Earn <strong>Care Credits</strong> through tree care, drain maintenance, and community service</li>
          <li>Use Care Credits to vote on proposals and participate in governance</li>
        </ol>

        <h3>ğŸ† Achievements</h3>
        <p class="small">
          Each module has unique achievements. Complete daily quests for bonus XP. 
          Rare achievements unlock special badges and community recognition.
        </p>

        <h3>ğŸ” Privacy</h3>
        <p class="small">
          All your data stays on your device in IndexedDB. We never track you without consent. 
          You can export or delete your data anytime.
        </p>

        <h3>ğŸ†˜ Support</h3>
        <p class="small">
          Questions? Join the community chat (bottom-left) or email:<br>
          <a href="mailto:admin@planetaryrestorationarchive.com">admin@planetaryrestorationarchive.com</a>
        </p>

        <button class="pill primary" data-action="modal-close" style="margin-top:20px; width:100%">
          Got It!
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Achievements Showcase -->
  <div id="modal-achievements" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ† Achievements</h2>
        <button class="modal-close" data-action="modal-close">Ã—</button>
      </div>
      <div class="modal-body">
        <p class="small muted">Track your progress across all modules. Rare achievements unlock special perks.</p>
        <div id="achievement-grid" style="margin-top:16px">
          <!-- Populated by JavaScript -->
          <p class="small muted">Complete actions to unlock achievements!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FOOTER: Attribution, Roadmap, License
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <footer class="wrap">
    <div style="border-top:1px solid var(--accent); padding-top:24px; margin-top:48px">
      <h3 style="font-size:1.1rem; margin-bottom:12px">ğŸ„ About This Project</h3>
      <p class="small">
        Crafted with â¤ï¸ by <strong>Foster + Navi</strong> for the <strong>Planetary Restoration Archive</strong>.<br>
        Website: <a href="https://planetaryrestorationarchive.com" target="_blank" rel="noopener">planetaryrestorationarchive.com</a>
      </p>

      <h4 style="font-size:1rem; margin:20px 0 8px 0">ğŸ“œ License & Attribution</h4>
      <p class="small">
        This work is licensed under <strong>CC BY-SA 4.0</strong> (Creative Commons Attribution-ShareAlike 4.0 International).<br>
        You are free to: Share, adapt, and build upon this work, even commercially, as long as you:
      </p>
      <ul style="margin-left:20px; font-size:.85rem">
        <li>Attribute the original creators (Foster + Navi, Planetary Restoration Archive)</li>
        <li>Share modifications under the same license</li>
        <li>Indicate if changes were made</li>
      </ul>
      <p class="small">
        <strong>Attributions:</strong> MapLibre GL JS (BSD-3), D3.js (ISC), Papaparse (MIT). 
        Full license texts: <a href="https://github.com/maplibre/maplibre-gl-js/blob/main/LICENSE.txt" target="_blank" rel="noopener">MapLibre</a>, 
        <a href="https://github.com/d3/d3/blob/main/LICENSE" target="_blank" rel="noopener">D3</a>, 
        <a href="https://github.com/mholt/PapaParse/blob/master/LICENSE" target="_blank" rel="noopener">Papaparse</a>
      </p>

      <h4 style="font-size:1rem; margin:20px 0 8px 0">ğŸ—ºï¸ Roadmap</h4>
      <ul style="margin-left:20px; font-size:.85rem">
        <li>âœ… Core module framework</li>
        <li>âœ… Gamification HUD</li>
        <li>âœ… Offline-first with Service Worker</li>
        <li>ğŸ”„ Smart contract deployment (testnet)</li>
        <li>ğŸ”„ Multi-city federation pilot (SF + Oakland + Berkeley)</li>
        <li>ğŸ“‹ Mobile app (React Native wrapper)</li>
        <li>ğŸ“‹ AR mode for on-site verification</li>
        <li>ğŸ“‹ Seasonal events & limited-time quests</li>
        <li>ğŸ“‹ Integration with city work order systems</li>
      </ul>

      <h4 style="font-size:1rem; margin:20px 0 8px 0">âš ï¸ Zero-Harm Commitment</h4>
      <p class="small">
        This tool is designed for <strong>civic empowerment, ecological restoration, and transparent governance</strong>. 
        It must NOT be used for:
      </p>
      <ul style="margin-left:20px; font-size:.85rem">
        <li>Surveillance without informed consent</li>
        <li>Extractive business models that harm communities</li>
        <li>Weaponization or targeting of vulnerable populations</li>
        <li>Environmental harm or greenwashing</li>
      </ul>
      <p class="small">
        If you encounter misuse, report to: <a href="mailto:admin@planetaryrestorationarchive.com">admin@planetaryrestorationarchive.com</a>
      </p>

      <div style="margin-top:24px; padding-top:16px; border-top:1px solid var(--accent); text-align:center">
        <p class="small muted">
          Made with mycelial love ğŸ„ â€¢ Version 2.0.0 â€¢ Last updated: 2025-10-15
        </p>
      </div>
    </div>
  </footer>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION 3: JAVASCRIPT â€” Core Engine
     
     This section contains all client-side logic:
     - Utilities (DOM helpers, UUID, SHA-256)
     - IndexedDB wrapper
     - Data adapters (DataSF, NOAA, IPFS)
     - Gamification engine
     - Map initialization
     - Event handlers
     - Service Worker registration
     - Constellation parallax animation
     
     EXPANSION AREAS:
     - Add WebSocket support for real-time updates
     - Implement quest progression tracking
     - Add achievement unlock animations
     - Build skill tree visualization
     - Add seasonal event system
     - Implement delegation/governance voting logic
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     UTILITIES & HELPERS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  
  const $ = (q, el=document) => el.querySelector(q);
  const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
  
  // Parse config from meta tag
  const cfg = (() => {
    const m = $('#cfg');
    if (!m) return {};
    return Object.fromEntries(
      [...m.attributes]
        .filter(a => a.name.startsWith('data-'))
        .map(a => [a.name.replace('data-', ''), a.value])
    );
  })();

  const sleep = ms => new Promise(r => setTimeout(r, ms));
  
  // UUID v4 generator
  const uuid = () => ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
  );

  // SHA-256 hash
  async function sha256(text) {
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // Date formatters
  const formatDate = (ts) => new Date(ts).toLocaleDateString();
  const formatTime = (ts) => new Date(ts).toLocaleTimeString();

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INDEXEDDB WRAPPER
     
     WHAT: Simple promise-based wrapper for IndexedDB operations
     STORES:
     - schemas: {id, name, data}
     - ledger: {id, type, ...} â€” all actions, credits, proposals
     - cache: {key, data, t} â€” API response cache
     - gamification: {xp, level, quests, achievements, streak}
     - analytics: {action, timestamp, module, metadata}
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  const idb = {
    db: null,
    
    async open() {
      return new Promise((res, rej) => {
        const req = indexedDB.open('mycelial-sf', 2);
        
        req.onupgradeneeded = e => {
          const db = e.target.result;
          
          // Create stores if they don't exist
          if (!db.objectStoreNames.contains('schemas')) {
            db.createObjectStore('schemas', {keyPath: 'id'});
          }
          if (!db.objectStoreNames.contains('ledger')) {
            db.createObjectStore('ledger', {keyPath: 'id'});
          }
          if (!db.objectStoreNames.contains('cache')) {
            db.createObjectStore('cache', {keyPath: 'key'});
          }
          if (!db.objectStoreNames.contains('gamification')) {
            const store = db.createObjectStore('gamification', {keyPath: 'id'});
            // Initialize with defaults
            store.put({
              id: 'player',
              xp: 0,
              level: 1,
              xpToNext: 100,
              streak: 0,
              actions: 0,
              lastAction: null,
              quests: [],
              achievements: []
            });
          }
          if (!db.objectStoreNames.contains('analytics')) {
            db.createObjectStore('analytics', {keyPath: 'id', autoIncrement: true});
          }
        };
        
        req.onsuccess = () => {
          idb.db = req.result;
          res(idb.db);
        };
        
        req.onerror = () => rej(req.error);
      });
    },
    
    put(store, obj) {
      return new Promise((res, rej) => {
        const tx = this.db.transaction(store, 'readwrite');
        tx.objectStore(store).put(obj);
        tx.oncomplete = () => res(true);
        tx.onerror = () => rej(tx.error);
      });
    },
    
    get(store, key) {
      return new Promise((res, rej) => {
        const tx = this.db.transaction(store, 'readonly');
        const r = tx.objectStore(store).get(key);
        r.onsuccess = () => res(r.result);
        r.onerror = () => rej(r.error);
      });
    },
    
    all(store) {
      return new Promise((res, rej) => {
        const tx = this.db.transaction(store, 'readonly');
        const r = tx.objectStore(store).getAll();
        r.onsuccess = () => res(r.result || []);
        r.onerror = () => rej(r.error);
      });
    },
    
    delete(store, key) {
      return new Promise((res, rej) => {
        const tx = this.db.transaction(store, 'readwrite');
        tx.objectStore(store).delete(key);
        tx.oncomplete = () => res(true);
        tx.onerror = () => rej(tx.error);
      });
    },
    
    clear(store) {
      return new Promise((res, rej) => {
        const tx = this.db.transaction(store, 'readwrite');
        tx.objectStore(store).clear();
        tx.oncomplete = () => res(true);
        tx.onerror = () => rej(tx.error);
      });
    }
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GAMIFICATION ENGINE
     
     WHAT: XP tracking, level-up logic, quest management, achievements
     HOW IT WORKS:
     - Actions award XP based on type/difficulty
     - XP accumulates, triggers level-ups
     - Quests have progress counters
     - Achievements unlock based on milestones
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  const gamification = {
    // XP rewards by action type
    xpTable: {
      'sync-trees': 15,
      'post-intent': 15,
      'issue-credit': 20,
      'report-311': 8,
      'claim-bounty': 20,
      'join-pod': 10,
      'schedule-drill': 40,
      'submit-proposal': 25,
      'vote': 5,
      'new-order': 5,
      'complete-pickup': 12
    },
    
    // Level thresholds (XP required for each level)
    levelThresholds: [
      0, 100, 250, 500, 850, 1300, 1900, 2600, 3400, 4300, 5300,
      6500, 7900, 9500, 11300, 13300, 15500, 18000, 20800, 24000
    ],
    
    async getPlayerData() {
      return await idb.get('gamification', 'player');
    },
    
    async awardXP(action, amount) {
      const player = await this.getPlayerData();
      const multiplier = parseFloat(cfg['xp-multiplier'] || 1.0);
      const xp = Math.floor((amount || this.xpTable[action] || 10) * multiplier);
      
      player.xp += xp;
      player.actions += 1;
      player.lastAction = Date.now();
      
      // Check level-up
      while (player.xp >= player.xpToNext) {
        player.level += 1;
        player.xpToNext = this.levelThresholds[player.level] || (player.xpToNext * 1.5);
        await this.onLevelUp(player.level);
      }
      
      await idb.put('gamification', player);
      this.updateHUD();
      
      // Log analytics if opted in
      if ($('#analytics-opt-in')?.checked) {
        await idb.put('analytics', {
          action,
          xp,
          timestamp: Date.now(),
          module: 'core'
        });
      }
      
      return {xp, level: player.level};
    },
    
    async onLevelUp(level) {
      // Confetti animation
      this.confetti();
      
      // Update HUD with animation
      const levelEl = $('#hud-level');
      if (levelEl) {
        levelEl.classList.add('level-up-anim');
        setTimeout(() => levelEl.classList.remove('level-up-anim'), 600);
      }
      
      // Notification
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('ğŸ‰ Level Up!', {
          body: `You've reached level ${level}!`,
          icon: '/icon-192.png'
        });
      }
      
      console.log(`ğŸ‰ Level up! Now level ${level}`);
    },
    
    confetti() {
      const colors = ['#00d1ff', '#00c896', '#ffc857', '#ff4d6d', '#7209b7'];
      for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'confetti-particle';
        particle.style.left = `${Math.random() * 100}vw`;
        particle.style.top = '100vh';
        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
        particle.style.animationDelay = `${Math.random() * 0.3}s`;
        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 2000);
      }
    },
    
    async updateHUD() {
      const player = await this.getPlayerData();
      if (!player) return;
      
      $('#hud-level').textContent = `Lvl ${player.level}`;
      $('#xp-current').textContent = player.xp;
      $('#xp-next').textContent = `/ ${player.xpToNext} XP`;
      $('#xp-bar').style.width = `${(player.xp / player.xpToNext) * 100}%`;
      $('#stat-streak').textContent = player.streak;
      $('#stat-actions').textContent = player.actions;
      
      // Update quests
      await this.updateQuests();
    },
    
    async updateQuests() {
      const player = await this.getPlayerData();
      const questList = $('#quest-list');
      if (!questList || !player.quests) return;
      
      questList.innerHTML = player.quests.map(q => `
        <div class="quest-item ${q.complete ? 'complete' : ''}">
          <div class="quest-title">${q.title}</div>
          <div class="quest-progress">
            <span>${q.progress} / ${q.target}</span>
            <span class="quest-reward">+${q.reward} XP</span>
          </div>
        </div>
      `).join('');
    },
    
    async initializeQuests() {
      const player = await this.getPlayerData();
      if (player.quests.length === 0) {
        // Default daily quests
        player.quests = [
          {id: 'sync-trees-daily', title: 'Sync street trees data', progress: 0, target: 1, reward: 25, complete: false},
          {id: 'post-intents-daily', title: 'Post 3 civic intents', progress: 0, target: 3, reward: 50, complete: false},
          {id: 'issue-credit-daily', title: 'Complete a care credit', progress: 0, target: 1, reward: 30, complete: false}
        ];
        await idb.put('gamification', player);
      }
      this.updateQuests();
    },
    
    async progressQuest(questId, amount = 1) {
      const player = await this.getPlayerData();
      const quest = player.quests.find(q => q.id === questId);
      if (!quest || quest.complete) return;
      
      quest.progress += amount;
      if (quest.progress >= quest.target) {
        quest.complete = true;
        await this.awardXP('quest-complete', quest.reward);
      }
      
      await idb.put('gamification', player);
      this.updateQuests();
    }
  };

  // CONTINUES IN NEXT SECTION...
javascript
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DATA ADAPTERS
     
     WHAT: Standardized interfaces to external APIs and data sources
     ADAPTERS:
     - DataSF (Socrata): SF open data portal
     - NOAA/NWS: Weather and climate
     - IPFS: Decentralized storage via Web3.Storage
     - Custom: Extensible adapter registration
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  const adapters = {
    // Rate limiting
    _rateLimits: new Map(),
    _maxRequests: 10,
    _windowMs: 60000, // 1 minute
    
    async checkRateLimit(key) {
      const now = Date.now();
      const history = this._rateLimits.get(key) || [];
      const recentRequests = history.filter(t => now - t < this._windowMs);
      
      if (recentRequests.length >= this._maxRequests) {
        throw new Error(`Rate limit exceeded for ${key}. Try again in ${Math.ceil((this._windowMs - (now - recentRequests[0])) / 1000)}s`);
      }
      
      recentRequests.push(now);
      this._rateLimits.set(key, recentRequests);
    },
    
    // DataSF (Socrata) adapter
    async datasf(path, params = {}) {
      await this.checkRateLimit('datasf');
      
      const base = cfg['datasf-root'] || 'https://data.sfgov.org/resource/';
      const url = new URL(base + path);
      
      for (const [k, v] of Object.entries(params)) {
        url.searchParams.set(k, v);
      }
      
      try {
        const r = await fetch(url.toString());
        if (!r.ok) throw new Error(`DataSF error: ${r.status}`);
        return await r.json();
      } catch (err) {
        console.error('DataSF adapter error:', err);
        throw err;
      }
    },
    
    // Street trees (124k+ records in SF)
    async trees(limit = 100) {
      const key = $('[data-k="trees-key"]')?.textContent.trim() || 'tkzw-k3nq';
      
      // Check cache first (24h TTL)
      const cached = await idb.get('cache', 'trees-data');
      if (cached && Date.now() - cached.t < 24 * 3600 * 1000) {
        console.log('Trees loaded from cache');
        return cached.data.slice(0, limit);
      }
      
      // Fetch fresh data
      const data = await this.datasf(`${key}.json`, {$limit: String(limit)});
      await idb.put('cache', {key: 'trees-data', data, t: Date.now()});
      
      return data;
    },
    
    // 311 cases (filtered to last 24h by default)
    async threeoneone(limit = 100, hoursBack = 24) {
      const key = $('[data-k="311-key"]')?.textContent.trim() || 'vw6y-z8j6';
      const dt = new Date(Date.now() - hoursBack * 3600 * 1000).toISOString();
      
      try {
        return await this.datasf(`${key}.json`, {
          $limit: String(limit),
          $where: `opened > '${dt}'`,
          $order: 'opened DESC'
        });
      } catch (err) {
        console.warn('311 fetch failed, using empty dataset:', err);
        return [];
      }
    },
    
    // NOAA weather data
    async weather(stationId = 'KSFO') {
      await this.checkRateLimit('noaa');
      
      try {
        const r = await fetch(`https://api.weather.gov/stations/${stationId}/observations/latest`);
        if (!r.ok) throw new Error(`NOAA error: ${r.status}`);
        return await r.json();
      } catch (err) {
        console.warn('Weather fetch failed:', err);
        return null;
      }
    },
    
    // IPFS pinning via Web3.Storage
    async ipfsPut(data) {
      const secrets = await idb.get('cache', 'secrets');
      const token = secrets?.data?.w3sToken;
      
      if (!token) {
        throw new Error('Web3.Storage token not configured. Set it in Settings.');
      }
      
      const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
      
      try {
        const r = await fetch('https://api.web3.storage/upload', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'X-NAME': `mycelial-${Date.now()}.json`
          },
          body: blob
        });
        
        if (!r.ok) throw new Error(`IPFS pin failed: ${r.status}`);
        
        const result = await r.json();
        return result.cid;
      } catch (err) {
        console.error('IPFS pin error:', err);
        throw err;
      }
    },
    
    // IPFS fetch
    async ipfsGet(cid) {
      const gateway = cfg['ipfs-gateway'] || 'https://ipfs.io/ipfs/';
      
      try {
        const r = await fetch(gateway + cid);
        if (!r.ok) throw new Error(`IPFS fetch failed: ${r.status}`);
        return await r.json();
      } catch (err) {
        console.error('IPFS fetch error:', err);
        throw err;
      }
    }
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BLOCKCHAIN / WEB3 HELPERS
     
     WHAT: Connect to EVM and Solana wallets, post intents on-chain
     SECURITY: Always validate user input before signing transactions
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  const chains = {
    evmProvider: null,
    solProvider: null,
    
    async evmConnect() {
      if (!window.ethereum) {
        throw new Error('No EVM wallet detected. Install MetaMask or similar.');
      }
      
      try {
        const accounts = await window.ethereum.request({
          method: 'eth_requestAccounts'
        });
        
        this.evmProvider = window.ethereum;
        
        return {
          provider: 'injected',
          accounts,
          chainId: await window.ethereum.request({method: 'eth_chainId'})
        };
      } catch (err) {
        console.error('EVM connection error:', err);
        throw err;
      }
    },
    
    async solConnect() {
      if (!window.solana?.isPhantom) {
        throw new Error('Phantom wallet not detected. Install from phantom.app');
      }
      
      try {
        const resp = await window.solana.connect();
        this.solProvider = window.solana;
        
        return {
          provider: 'phantom',
          pubkey: resp.publicKey.toString()
        };
      } catch (err) {
        console.error('Solana connection error:', err);
        throw err;
      }
    },
    
    async postIntent(module, dataURI) {
      // This is a simplified version - in production, call actual smart contract
      const intentId = uuid();
      const intent = {
        id: `urn:action:${intentId}`,
        schema: 'mycelial.action.v1',
        module,
        dataURI,
        proposer: this.evmProvider ? (await this.evmProvider.request({method: 'eth_accounts'}))[0] : 'local',
        timestamp: Date.now()
      };
      
      // Store locally (in production, this would be on-chain)
      await idb.put('ledger', intent);
      
      console.log('Intent posted:', intent);
      return intentId;
    }
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAP INITIALIZATION (MapLibre GL JS)
     
     WHAT: Interactive map with 311, trees, and module-specific layers
     LAYERS:
     - Basemap: Carto vector tiles (Voyager/Positron/Dark Matter)
     - 311 Cases: Clustered red circles
     - Street Trees: Green circles
     - Custom module layers
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  let map = null;
  let mapStyleIndex = 1; // Start with Voyager

  const MAP_STYLES = [
    {
      name: 'positron',
      url: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json'
    },
    {
      name: 'voyager',
      url: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json'
    },
    {
      name: 'dark',
      url: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json'
    }
  ];

  async function mapInit() {
    if (!window.maplibregl) {
      console.warn('MapLibre not loaded, skipping map init');
      return;
    }
    
    const mapEl = $('#map');
    if (!mapEl) return;
    
    try {
      map = new maplibregl.Map({
        container: 'map',
        style: MAP_STYLES[mapStyleIndex].url,
        center: [-122.4194, 37.7749], // SF city center
        zoom: 11,
        attributionControl: true
      });
      
      // Add navigation controls
      map.addControl(new maplibregl.NavigationControl(), 'top-right');
      
      // Wait for map to load before adding layers
      map.on('load', async () => {
        await mapAddLayers();
      });
      
    } catch (err) {
      console.error('Map initialization error:', err);
    }
  }

  async function mapAddLayers() {
    if (!map) return;
    
    try {
      // Layer 1: 311 Cases
      if ($('#layer-311')?.checked) {
        const cases = await adapters.threeoneone(500);
        const geojson = {
          type: 'FeatureCollection',
          features: cases.map(c => ({
            type: 'Feature',
            properties: {
              type: '311',
              category: c.service_name || 'Unknown',
              status: c.status || 'Open',
              opened: c.opened || ''
            },
            geometry: {
              type: 'Point',
              coordinates: [
                parseFloat(c.point?.longitude || c.long) || -122.4194,
                parseFloat(c.point?.latitude || c.lat) || 37.7749
              ]
            }
          }))
        };
        
        map.addSource('311-cases', {
          type: 'geojson',
          data: geojson,
          cluster: true,
          clusterMaxZoom: 14,
          clusterRadius: 50
        });
        
        // Clustered circles
        map.addLayer({
          id: '311-clusters',
          type: 'circle',
          source: '311-cases',
          filter: ['has', 'point_count'],
          paint: {
            'circle-color': [
              'step',
              ['get', 'point_count'],
              '#ff4d6d',
              10, '#ff6b9d',
              30, '#ff1744'
            ],
            'circle-radius': [
              'step',
              ['get', 'point_count'],
              15, 10, 20, 30, 25
            ],
            'circle-opacity': 0.7,
            'circle-stroke-width': 2,
            'circle-stroke-color': '#fff'
          }
        });
        
        // Cluster count labels
        map.addLayer({
          id: '311-cluster-count',
          type: 'symbol',
          source: '311-cases',
          filter: ['has', 'point_count'],
          layout: {
            'text-field': '{point_count_abbreviated}',
            'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
            'text-size': 12
          },
          paint: {
            'text-color': '#ffffff'
          }
        });
        
        // Unclustered points
        map.addLayer({
          id: '311-unclustered',
          type: 'circle',
          source: '311-cases',
          filter: ['!', ['has', 'point_count']],
          paint: {
            'circle-color': '#ff4d6d',
            'circle-radius': 6,
            'circle-opacity': 0.8,
            'circle-stroke-width': 1,
            'circle-stroke-color': '#fff'
          }
        });
        
        // Click handler for popups
        map.on('click', '311-unclustered', (e) => {
          const props = e.features[0].properties;
          new maplibregl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`
              <strong>311 Case</strong><br>
              Category: ${props.category}<br>
              Status: ${props.status}<br>
              Opened: ${props.opened ? new Date(props.opened).toLocaleDateString() : 'N/A'}
            `)
            .addTo(map);
        });
        
        map.on('mouseenter', '311-unclustered', () => {
          map.getCanvas().style.cursor = 'pointer';
        });
        
        map.on('mouseleave', '311-unclustered', () => {
          map.getCanvas().style.cursor = '';
        });
      }
      
      // Layer 2: Street Trees
      if ($('#layer-trees')?.checked) {
        const cached = await idb.get('cache', 'trees-data');
        if (cached?.data) {
          const trees = cached.data.slice(0, 1000); // Limit for performance
          const geojson = {
            type: 'FeatureCollection',
            features: trees.map(t => ({
              type: 'Feature',
              properties: {
                type: 'tree',
                species: t.qspecies || t.species || 'Unknown',
                address: t.qaddress || t.address || ''
              },
              geometry: {
                type: 'Point',
                coordinates: [
                  parseFloat(t.longitude) || -122.4194,
                  parseFloat(t.latitude) || 37.7749
                ]
              }
            }))
          };
          
          map.addSource('trees', {
            type: 'geojson',
            data: geojson
          });
          
          map.addLayer({
            id: 'trees-layer',
            type: 'circle',
            source: 'trees',
            paint: {
              'circle-color': '#00c896',
              'circle-radius': 4,
              'circle-opacity': 0.6,
              'circle-stroke-width': 1,
              'circle-stroke-color': '#00d1ff'
            }
          });
          
          map.on('click', 'trees-layer', (e) => {
            const props = e.features[0].properties;
            new maplibregl.Popup()
              .setLngLat(e.lngLat)
              .setHTML(`
                <strong>Street Tree</strong><br>
                Species: ${props.species}<br>
                Address: ${props.address}
              `)
              .addTo(map);
          });
        }
      }
      
    } catch (err) {
      console.error('Error adding map layers:', err);
    }
  }

  function mapRefresh() {
    if (!map) return;
    
    // Remove existing layers and sources
    ['311-clusters', '311-cluster-count', '311-unclustered', 'trees-layer'].forEach(id => {
      if (map.getLayer(id)) map.removeLayer(id);
    });
    
    ['311-cases', 'trees'].forEach(id => {
      if (map.getSource(id)) map.removeSource(id);
    });
    
    // Re-add layers
    mapAddLayers();
  }

  function mapFit() {
    if (!map) return;
    
    // Fit to SF bounds
    map.fitBounds([
      [-122.515, 37.703], // SW
      [-122.357, 37.833]  // NE
    ], {
      padding: 50,
      duration: 1000
    });
  }

  function mapExport() {
    if (!map) return;
    
    const canvas = map.getCanvas();
    const dataURL = canvas.toDataURL('image/png');
    
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = `mycelial-map-${Date.now()}.png`;
    a.click();
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CONSTELLATION PARALLAX ANIMATION
     
     WHAT: Multi-layer starfield that responds to mouse movement
     HOW IT WORKS:
     - 3 layers of stars at different depths (foreground, mid, background)
     - Mouse position affects star movement (parallax)
     - Stars drift slowly to the left
     - Canvas redraws at 60fps
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  let constellationAnimationId = null;
  let mouseX = 0;
  let mouseY = 0;

  function constellationInit() {
    const canvas = $('#starfield');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    let stars = [];
    
    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      // Regenerate stars on resize
      stars = [];
      const starCount = Math.floor((canvas.width * canvas.height) / 8000);
      
      for (let i = 0; i < starCount; i++) {
        stars.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          z: Math.random() * 3, // 0=bg, 1=mid, 2=fg
          size: Math.random() * 2 + 0.5,
          speed: Math.random() * 0.3 + 0.1
        });
      }
    }
    
    resize();
    window.addEventListener('resize', resize);
    
    // Mouse tracking for parallax
    document.addEventListener('mousemove', (e) => {
      mouseX = (e.clientX / window.innerWidth - 0.5) * 2;
      mouseY = (e.clientY / window.innerHeight - 0.5) * 2;
    });
    
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      stars.forEach(star => {
        // Drift + parallax
        const parallaxX = mouseX * star.z * 20;
        const parallaxY = mouseY * star.z * 20;
        
        star.x -= star.speed;
        if (star.x < 0) star.x = canvas.width;
        
        // Color based on depth
        const colors = [
          'rgba(74, 95, 127, 0.4)',   // bg
          'rgba(110, 143, 181, 0.6)',  // mid
          'rgba(165, 201, 255, 0.8)'   // fg
        ];
        
        ctx.fillStyle = colors[Math.floor(star.z)];
        ctx.beginPath();
        ctx.arc(
          star.x + parallaxX,
          star.y + parallaxY,
          star.size,
          0,
          Math.PI * 2
        );
        ctx.fill();
      });
      
      constellationAnimationId = requestAnimationFrame(animate);
    }
    
    animate();
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INTEGRITY VERIFICATION
     
     WHAT: Compute rolling SHA-256 hash of document, compare to expected
     WHY: Tamper detection, version verification
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  async function updateIntegrity() {
    try {
      const expected = cfg['expected-hash'] || '';
      const domText = document.documentElement.outerHTML
        .replace(/\s+/g, ' ')
        .replace(/hash: [a-f0-9]{64}/g, 'hash: PLACEHOLDER'); // Exclude self-reference
      
      const hash = await sha256(domText);
      const shortHash = hash.slice(0, 16);
      
      // Update banner
      const banner = $('#integrity-banner');
      if (banner) {
        banner.textContent = `ğŸ”’ hash: ${shortHash}...`;
      }
      
      // Update full hash display
      const hashLine = $('#hash-line');
      if (hashLine) {
        hashLine.textContent = hash;
      }
      
      // Update expected hash display
      const expectedEl = $('#expected-hash');
      if (expectedEl && expected && expected !== 'EXPECTED_HASH_TO_SET_POST_DEPLOY') {
        expectedEl.textContent = expected;
      }
      
      // Status check
      const status = $('#hash-status');
      if (status && expected && expected !== 'EXPECTED_HASH_TO_SET_POST_DEPLOY') {
        const match = (hash === expected);
        status.innerHTML = match 
          ? '<strong>Status:</strong> <span style="color:var(--ok)">âœ… VERIFIED</span>'
          : '<strong>Status:</strong> <span style="color:var(--warn)">âš ï¸ MISMATCH</span>';
      } else if (status) {
        status.innerHTML = '<strong>Status:</strong> <span class="muted">Expected hash not set</span>';
      }
      
    } catch (err) {
      console.error('Integrity check error:', err);
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL MANAGEMENT
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  function showModal(id) {
    const modal = $(`#${id}`);
    if (modal) {
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden'; // Prevent background scroll
    }
  }

  function hideModals() {
    ['modal-proposal', 'modal-settings', 'modal-help', 'modal-achievements'].forEach(id => {
      const modal = $(`#${id}`);
      if (modal) {
        modal.style.display = 'none';
      }
    });
    document.body.style.overflow = '';
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EVENT HANDLERS
     
     WHAT: Central click handler for all interactive elements
     PATTERN: Use data-action attributes for declarative event binding
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  async function handleAction(e) {
    const btn = e.target.closest('button.pill, button.icon-btn');
    if (!btn) return;
    
    const action = btn.getAttribute('data-action');
    if (!action) return;
    
    // Prevent double-clicks
    if (btn.disabled) return;
    btn.disabled = true;
    
    try {
      // Module actions
      if (action === 'post-intent') {
        const module = btn.getAttribute('data-module');
        await gamification.awardXP('post-intent');
        await gamification.progressQuest('post-intents-daily');
        
        const intentId = await chains.postIntent(module, 'ipfs://demo');
        alert(`Intent posted! ID: ${intentId.slice(0, 8)}...\n+15 XP earned`);
      }
      
      if (action === 'sync-trees') {
        const data = await adapters.trees(500);
        $('#kpi-trees').textContent = data.length.toLocaleString();
        $('#tree-cache-count').textContent = data.length;
        
        await idb.put('cache', {key: 'trees-data', data, t: Date.now()});
        await gamification.awardXP('sync-trees');
        await gamification.progressQuest('sync-trees-daily');
        
        alert(`${data.length} trees cached!\n+15 XP earned`);
      }
      
      if (action === 'issue-credit') {
        const creditId = uuid();
        await idb.put('ledger', {
          id: creditId,
          type: 'credit',
          amount: 1,
          memo: 'Tree care action',
          timestamp: Date.now()
        });
        
        await gamification.awardXP('issue-credit');
        await gamification.progressQuest('issue-credit-daily');
        
        // Update care credits counter
        const ledger = await idb.all('ledger');
        const totalCredits = ledger.filter(l => l.type === 'credit').length;
        $('#care-credits-total').textContent = totalCredits;
        
        alert('Care Credit issued!\n+20 XP earned');
      }
      
      if (action === 'report-311') {
        const caseId = uuid();
        await idb.put('ledger', {
          id: caseId,
          type: '311',
          category: 'Demo case',
          timestamp: Date.now()
        });
        
        await gamification.awardXP('report-311');
        alert('311 case reported!\n+8 XP earned');
      }
      
      // Map actions
      if (action === 'map-refresh') {
        mapRefresh();
      }
      
      if (action === 'map-fit') {
        mapFit();
      }
      
      if (action === 'map-export') {
        mapExport();
      }
      
      // Blockchain actions
      if (action === 'evm-connect') {
        const result = await chains.evmConnect();
        alert(`EVM Connected!\nAccount: ${result.accounts[0].slice(0, 10)}...\nChain ID: ${result.chainId}`);
      }
      
      if (action === 'sol-connect') {
        const result = await chains.solConnect();
        alert(`Solana Connected!\nPubkey: ${result.pubkey.slice(0, 10)}...`);
      }
      
      if (action === 'simulate') {
        const ledger = await idb.all('ledger');
        alert(`Simulation Mode\n\nLocal ledger entries: ${ledger.length}\nXP tracking: Active\nOffline mode: Ready`);
      }
      
      // Governance actions
      if (action === 'new-proposal') {
        showModal('modal-proposal');
      }
      
      if (action === 'open-ledger') {
        const ledger = await idb.all('ledger');
        const blob = new Blob([JSON.stringify(ledger, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ledger-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }
      
      if (action === 'export-manifest') {
        const hash = $('#hash-line')?.textContent || 'unknown';
        const manifest = {
          title: 'San Francisco Mycelial Solutions',
          version: '2.0.0',
          owner: cfg['site-owner'],
          url: cfg['site-url'],
          city: cfg.city,
          timestamp: Date.now(),
          sha256: hash,
          license: 'CC BY-SA 4.0'
        };
        
        const blob = new Blob([JSON.stringify(manifest, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mycelial-manifest-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }
      
      // Proposal modal actions
      if (action === 'prop-save' || action === 'prop-pin') {
        const title = $('#prop-title')?.value.trim();
        const module = $('#prop-module')?.value;
        const summary = $('#prop-summary')?.value.trim();
        const amount = parseFloat($('#prop-amount')?.value || 0);
        
        if (!title || !summary) {
          alert('Please fill in title and summary');
          return;
        }
        
        const proposal = {
          id: uuid(),
          type: 'proposal',
          title,
          module,
          summary,
          fundingRequest: amount,
          timestamp: Date.now()
        };
        
        await idb.put('ledger', proposal);
        await gamification.awardXP('submit-proposal');
        
        if (action === 'prop-pin') {
          try {
            const cid = await adapters.ipfsPut(proposal);
            alert(`Proposal saved & pinned to IPFS!\nCID: ${cid}\n+25 XP earned`);
          } catch (err) {
            alert(`Proposal saved locally.\nIPFS pin failed: ${err.message}\n+25 XP earned`);
          }
        } else {
          alert('Proposal saved locally!\n+25 XP earned');
        }
        
        hideModals();
        
        // Clear form
        $('#prop-title').value = '';
        $('#prop-summary').value = '';
        $('#prop-amount').value = '';
      }
      
      // Settings actions
      if (action === 'open-settings' || action === 'settings-save') {
        if (action === 'open-settings') {
          const secrets = await idb.get('cache', 'secrets');
          $('#w3s-token').value = secrets?.data?.w3sToken || '';
          showModal('modal-settings');
        } else {
          const token = $('#w3s-token')?.value.trim();
          await idb.put('cache', {
            key: 'secrets',
            data: {w3sToken: token},
            t: Date.now()
          });
          alert('Settings saved!');
          hideModals();
        }
      }
      
      if (action === 'settings-clear') {
        if (confirm('Clear all settings? This cannot be undone.')) {
          await idb.put('cache', {key: 'secrets', data: {}, t: Date.now()});
          $('#w3s-token').value = '';
          alert('Settings cleared');
        }
      }
      
      // Modal close
      if (action === 'modal-close') {
        hideModals();
      }
      
      // Analytics actions
      if (action === 'view-my-data') {
        const analytics = await idb.all('analytics');
        const gamif = await idb.get('gamification', 'player');
        const ledger = await idb.all('ledger');
        
        const report = {
          analytics,
          gamification: gamif,
          ledgerSize: ledger.length,
          exportDate: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `my-data-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        alert(`Your data exported!\n\nAnalytics events: ${analytics.length}\nLedger entries: ${ledger.length}\nTotal XP: ${gamif?.xp || 0}`);
      }
      
      if (action === 'purge-data') {
        if (confirm('âš ï¸ Delete ALL your data? This includes XP, achievements, and ledger entries. Cannot be undone.')) {
          await idb.clear('analytics');
          await idb.clear('ledger');
          await idb.clear('cache');
          
          // Reset gamification
          await idb.put('gamification', {
            id: 'player',
            xp: 0,
            level: 1,
            xpToNext: 100,
            streak: 0,
            actions: 0,
            lastAction: null,
            quests: [],
            achievements: []
          });
          
          alert('All data purged. Refresh to restart.');
          location.reload();
        }
      }
      
      // Integrity actions
      if (action === 'copy-hash') {
        const hash = $('#hash-line')?.textContent;
        if (hash) {
          await navigator.clipboard.writeText(hash);
          alert('Hash copied to clipboard!');
        }
      }
      
      // XMR action
      if (action === 'copy-xmr') {
        const addr = $('#xmr-addr')?.textContent;
        if (addr) {
          await navigator.clipboard.writeText(addr);
          alert('XMR address copied!');
        }
      }
      
      // Schema actions
      if (action === 'save-schema') {
        const schemaId = 'schema-' + uuid();
        await idb.put('schemas', {
          id: schemaId,
          name: 'mycelial.action.v1',
          timestamp: Date.now()
        });
        alert('Schema saved to IndexedDB!');
      }
      
      // Help
      if (action === 'help-open') {
        showModal('modal-help');
      }
      
    } catch (err) {
      console.error('Action error:', err);
      alert(`Error: ${err.message}`);
    } finally {
      // Re-enable button after short delay
      setTimeout(() => {
        btn.disabled = false;
      }, 500);
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SERVICE WORKER REGISTRATION (Offline Support)
     
     WHAT: Register SW for offline caching
     WHY: App continues to work without internet connection
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  async function registerServiceWorker() {
    if (!('serviceWorker' in navigator)) {
      console.warn('Service Worker not supported');
      return;
    }
    
    // Create SW from inline code (blob URL)
    const swCode = `
      const CACHE_NAME = 'mycelial-sf-v2';
      const urlsToCache = [
        './',
        './index.html'
      ];
      
      self.addEventListener('install', event => {
        event.waitUntil(
          caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
        );
      });
      
      self.addEventListener('fetch', event => {
        event.respondWith(
          caches.match(event.request).then(response => {
            if (response) return response;
            
            return fetch(event.request).then(response => {
              if (!response || response.status !== 200 || response.type !== 'basic') {
                return response;
              }
              
              const responseToCache = response.clone();
              caches.open(CACHE_NAME).then(cache => {
                cache.put(event.request, responseToCache);
              });
              
              return response;
            }).catch(() => {
              // Return cached index.html as fallback
              return caches.match('./');
            });
          })
        );
      });
      
      self.addEventListener('activate', event => {
        const cacheWhitelist = [CACHE_NAME];
        event.waitUntil(
          caches.keys().then(cacheNames => {
            return Promise.all(
              cacheNames.map(cacheName => {
                if (!cacheWhitelist.includes(cacheName)) {
                  return caches.delete(cacheName);
                }
              })
            );
          })
        );
      });
    `;
    
    try {
      const blob = new Blob([swCode], {type: 'application/javascript'});
      const swURL = URL.createObjectURL(blob);
      
      await navigator.serviceWorker.register(swURL);
      console.log('âœ… Service Worker registered');
    } catch (err) {
      console.warn('Service Worker registration failed:', err);
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     THEME MANAGEMENT
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  function initTheme() {
    const savedTheme = localStorage.getItem('mycelial-theme') || cfg.theme || 'auto';
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    // Update active state in menu
    $$('.theme-option').forEach(opt => {
      opt.classList.toggle('active', opt.dataset.theme === savedTheme);
    });
  }

  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('mycelial-theme', theme);
    
    // Update menu
    $$('.theme-option').forEach(opt => {
      opt.classList.toggle('active', opt.dataset.theme === theme);
    });
    
    // Close menu
    $('#theme-menu').style.display = 'none';
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BOOT SEQUENCE
     
     WHAT: Initialize app on page load
     ORDER:
     1. Open IndexedDB
     2. Initialize gamification
     3. Start constellation animation
     4. Initialize map
     5. Load KPIs
     6. Register service worker
     7. Start integrity checker
     8. Bind event handlers
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  async function boot() {
    console.log('ğŸ„ Mycelial Solutions booting...');
    
    try {
      // 1. IndexedDB
      await idb.open();
      console.log('âœ… IndexedDB ready');
      
      // 2. Gamification
      await gamification.updateHUD();
      await gamification.initializeQuests();
      console.log('âœ… Gamification loaded');
      
      // 3. Theme
      initTheme();
      console.log('âœ… Theme initialized');
      
      // 4. Constellation animation
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        console.log('â­ï¸ Skipping animation (reduced motion)');
      } else {
        constellationInit();
        console.log('âœ… Constellation animation started');
      }
      
      // 5. Map
      if ($('#map')) {
        await mapInit();
        console.log('âœ… Map initialized');
      }
      
      // 6. Load KPIs
      try {
        // 311 cases
        const cases = await adapters.threeoneone(50);
        $('#kpi-311').textContent = cases.length;
        
        // Trees (from cache)
        const cached = await idb.get('cache', 'trees-data');
        if (cached) {
          $('#kpi-trees').textContent = cached.data.length.toLocaleString();
          $('#tree-cache-count').textContent = cached.data.length;
        }
        
        // Intents
        const ledger = await idb.all('ledger');
        $('#kpi-intents').textContent = ledger.length;
        
        // Care credits
        const credits = ledger.filter(l => l.type === 'credit').length;
        $('#care-credits-total').textContent = credits;
        
        // Health score (composite)
        const health = Math.min(100, Math.floor(
          (cached ? 35 : 0) + 
          (cases.length > 0 ? 35 : 0) + 
          (ledger.length > 0 ? 30 : 0)
        ));
        $('#kpi-health').textContent = health;
        $('#kpi-health').style.color = health > 70 ? 'var(--ok)' : health > 40 ? 'var(--warn)' : 'var(--bad)';
        
        console.log('âœ… KPIs loaded');
      } catch (err) {
        console.warn('KPI load errors (non-fatal):', err);
      }
      
      // 7. Service Worker
      registerServiceWorker();
      
      // 8. Integrity checker
      updateIntegrity();
      setInterval(updateIntegrity, 60000); // Every minute
      
      // 9. Event listeners
      document.addEventListener('click', handleAction);
      
      // Theme toggle
      $('#theme-toggle')?.addEventListener('click', (e) => {
        e.stopPropagation();
        const menu = $('#theme-menu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
      });
      
      $$('.theme-option').forEach(opt => {
        opt.addEventListener('click', () => {
          setTheme(opt.dataset.theme);
        });
      });
      
      // Close theme menu on outside click
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.theme-switcher')) {
          $('#theme-menu').style.display = 'none';
        }
      });
      
      // Help button
      $('#help-btn')?.addEventListener('click', () => {
        showModal('modal-help');
      });
      
      // XMR toggle
      $('#xmr-toggle')?.addEventListener('click', () => {
        const panel = $('#xmr-panel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
      });
      
      // Chat
      $('#chat-open')?.addEventListener('click', () => {
        const frame = $('#chat-frame');
        const iframe = $('#chat-iframe');
        
        if (frame.style.display === 'none') {
          const room = cfg['tlkio-room'] || 'mycelial-sf';
          iframe.src = `https://embed.tlk.io/${encodeURIComponent(room)}`;
          frame.style.display = 'block';
        } else {
          frame.style.display = 'none';
        }
      });
      
      $('#chat-close')?.addEventListener('click', () => {
        $('#chat-frame').style.display = 'none';
      });
      
      // Modal backdrop clicks
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
          hideModals();
        }
      });
      
      // Map layer toggles
      $$('input[id^="layer-"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          mapRefresh();
        });
      });
      
      // Map style switcher
      $$('[data-map-style]').forEach(btn => {
        btn.addEventListener('click', () => {
          const styleName = btn.dataset.mapStyle;
          const idx = MAP_STYLES.findIndex(s => s.name === styleName);
          if (idx !== -1 && map) {
            mapStyleIndex = idx;
            map.setStyle(MAP_STYLES[idx].url);
          }
        });
      });
      
      console.log('ğŸ‰ Boot complete!');
      
      // Welcome notification (if permission granted)
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('ğŸ„ Mycelial Solutions', {
          body: 'Ready to transform civic governance!',
          icon: '/icon-192.png'
        });
      }
      
    } catch (err) {
      console.error('âŒ Boot error:', err);
      alert(`Initialization error: ${err.message}\n\nSome features may not work. Please refresh.`);
    }
  }

  // Run boot when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }

  // Expose utilities to window for debugging
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    window.mycelial = {
      idb,
      adapters,
      chains,
      gamification,
      map,
      cfg
    };
    console.log('ğŸ”§ Debug utilities available at window.mycelial');
  }
  </script>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ZERO-HARM & ANTI-INVERSION FOOTER NOTE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--
    ZERO-HARM COMMITMENT:
    This tool is designed for civic empowerment, ecological restoration, and
    transparent governance. It must NOT be weaponized, used for surveillance
    without consent, or deployed to extract value from communities.
    
    If you discover misuse, please report to:
    admin@planetaryrestorationarchive.com
    
    LICENSE: CC BY-SA 4.0
    Attribution: Foster + Navi, Planetary Restoration Archive
    
    Full attributions:
    - MapLibre GL JS (BSD-3): https://maplibre.org
    - D3.js (ISC): https://d3js.org
    - Papaparse (MIT): https://www.papaparse.com
  -->

</body>
</html>

